<div style="text-align: center;"><figure><img src="../../img/ut05/img08_06-login-password.gif"  style="zoom: 100%;" /><figcaption style="font-size: 13px; color: #bd8f04;">Ejemplo de introducción de usuario y contraseña.</figcaption></figure></div>

Para manejar un sistema completo de login y password con contraseñas cifradas, necesitamos un método que cifre esos strings que el usuario introduce como contraseña; tanto en el formulario de registro como en el del login, ya que al codificar una contraseña, después tenemos que decodificarla para comprobar que ambas contrasñeas (la que instroduce el usuario en el login y la que tenemos en la base de datos) coincidan.

Necesitamos pues:

1º ) `password_hash()` para almacenar la contraseña en la base de datos a la hora de hacer el INSERT.

- `PASSWORD_DEFAULT` almacenamos la contraseña usando el método de encriptación *bcrypt*.
- `PASSWORD_BCRYPT` almacenamos la contraseña usando el algoritmo CRYPT_BLOWFISH compatible con crypt().

2º ) `password_verify()` para verificar el usuario y la contraseña.

Ejemplo:

```html
<form action="loginCrear.php" method="post">
    <label for="usuario">usuario: </label>
    <input type="text" name="usuario">
    
    <label for="password">password: </label>
    <input type="password" name="password"> 

    <input type="submit" name="enviar" value="enviar">
</form>
```

```php
<?php
  // loginCrear.php
  include "config/database.inc.php";

  $conexion = null;
  try{
    $conexion = new PDO($dsn, $usuario, $contrasenya);
    $conexion -> setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $usu = $_POST["usuario"];
    $pas = $_POST["password"];    
    $fechaActual = date("Y-m-d H:i:s"); 
    $cre = $fechaActual; 
    $acc = $fechaActual;  

    // Encriptar la contraseña
    $pasE= password_hash($pas, PASSWORD_DEFAULT);

    $sql = "INSERT INTO users (username, password, creacion, actualizacion) 
                                      VALUES (:usu, :pas, :cre, :acc)";

    $sentencia = $conexion -> prepare($sql);
    $sentencia -> bindParam (':usu', $usu);  
    $sentencia -> bindParam (':pas', $pasE);  
    $sentencia -> bindParam (':cre', $cre);  
    $sentencia -> bindParam (':acc', $acc);  
    $isOk = $sentencia -> execute();
    //$idGenerado = $conexion -> lastInsertId();

  } catch (PDOException $e) {
    echo $e -> getMessage();
  }

  $conexion = null;  
```

Ahora que tenemos el usuario codificado y guardado en la base de datos, vamos a recuperarlo para poder loguearlo correctamente.

```php
<?php
  // Recuperar usuario y password en BD
  include "config/database.inc.php";
  $conexion = null;
  try{
    $conexion = new PDO(DSN, USUARIO, PASSWORD);
    $conexion -> setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $usu = $_POST["usuario"] ?? "";
    $sql = "select * from usuarios where usuario = :usu";

    $sentencia = $conexion -> prepare($sql);
    $sentencia -> bindParam (':usu', $usu);  
    $sentencia -> execute();

    $usuario = $sentencia -> fetch();

    if($usuario && password_verify($_POST['password'], $usuario['password'])) {
        echo "OK!";
    } else {
        echo "Usuario y/o contraseña no son correctos.";
    }
  } catch (PDOException $e){
    echo $e->getMessage();
 }
 $conexion = null;
```

??? ies "Ejercicios a realizar"
	- `Ejercicio 508`<br />

??? ies "Realizar, además, la actividad proyecto CholloCenter"
	- `Ejercicio 415`<br />
	- `Ejercicio 416`<br />
	- `Ejercicio 417`<br />
	- `Ejercicio 418`<br />
