# Pr√°ctica guiada

==**Consumo de una API REST externa con Laravel**==

## Objetivo

En esta pr√°ctica vas a crear una mini-aplicaci√≥n Laravel que consume una API REST externa en lugar de usar tu propia base de datos.

Trabajaremos con la API p√∫blica Pok√©API ([https://pokeapi.co/api/v2/](https://pokeapi.co/api/v2/){:target="_blank"}), que no requiere autenticaci√≥n. La aplicaci√≥n permitir√°:

- Listar pok√©mon paginados desde la API.
- Ver el detalle de un pok√©mon concreto.
- Manejar errores b√°sicos (API ca√≠da, nombre inv√°lido‚Ä¶).
- (Opcional) Cachear las respuestas para no machacar la API.

> üí° Esta pr√°ctica asume que ya tienes configurado el entorno de las pr√°cticas anteriores (WSL2 + Ubuntu + Laravel + Sail) y que sabes levantar un proyecto Laravel con Sail.

## FASE 0: Crear el proyecto base
### 0.1. Crear el proyecto Laravel

Dentro de tu carpeta de desarrollo (por ejemplo ~/development/laravel), crea un nuevo proyecto:

```bash
cd ~/development/laravel
composer create-project laravel/laravel PokeClient
cd PokeClient
```

Si trabajas con Sail, instala Sail (si no lo has hecho ya):

```bash
php artisan sail:install
```

Selecciona MySQL (aunque en esta pr√°ctica no usaremos la BD, es √∫til tener entorno est√°ndar).

Levanta los contenedores:
```bash
./vendor/bin/sail up -d
```

> Si ya tienes el `alias` sail creado de pr√°cticas anteriores, puedes usar simplemente `sail up -d`.

### 0.2. Probar que Laravel funciona

Abre el navegador y visita:

- `http://localhost` (o el puerto que uses para Sail).

Comprueba que ves la p√°gina de bienvenida de Laravel.

---

## FASE 1: Entender la API externa (Pok√©API)

Antes de que Laravel ‚Äúataque‚Äù a la API, t√∫ como desarrollador debes entender qu√© devuelve.

### 1.1. Listado de pok√©mon

Abre en el navegador:

[https://pokeapi.co/api/v2/pokemon?limit=20&offset=0](https://pokeapi.co/api/v2/pokemon?limit=20&offset=0){:target="_blank"}

Observa que la respuesta es un JSON similar a:

```json
{
  "count": 1302,
  "next": "https://pokeapi.co/api/v2/pokemon?offset=20&limit=20",
  "previous": null,
  "results": [
    {"name": "bulbasaur", "url": "https://pokeapi.co/api/v2/pokemon/1/"},
    ...
  ]
}
```

Qu√© te interesa:

- `results`: lista de pok√©mon, cada uno con `name` y `url`.
- `next`, `previous`: enlaces para paginar.

### 1.2. Detalle de un pok√©mon

Abre en el navegador:

- [https://pokeapi.co/api/v2/pokemon/pikachu](https://pokeapi.co/api/v2/pokemon/pikachu){:target="_blank"}
- [https://pokeapi.co/api/v2/pokemon/1](https://pokeapi.co/api/v2/pokemon/1){:target="_blank"}

F√≠jate en algunos campos √∫tiles:

- `name`
- `id`
- `sprites.front_default` (imagen)
- `height`, `weight`
- `types` (lista de tipos)
- `stats` (estad√≠sticas)

> üéØ Objetivo de la fase: saber qu√© campos vas a usar en tus vistas para mostrar informaci√≥n.

---

## FASE 2: Configurar el cliente HTTP en Laravel

Laravel incluye un cliente HTTP basado en Guzzle a trav√©s del facade `Http`.

### 2.1. A√±adir configuraci√≥n en `.env`

Edita el archivo `.env` y a√±ade al final:

```dotenv
POKEAPI_BASE_URL=https://pokeapi.co/api/v2/
POKEAPI_TIMEOUT=5
```

### 2.2. Registrar la configuraci√≥n en config/services.php

Abre config/services.php y a√±ade este bloque al final del array:

```php
'pokeapi' => [
    'base_url' => env('POKEAPI_BASE_URL', 'https://pokeapi.co/api/v2/'),
    'timeout'  => env('POKEAPI_TIMEOUT', 5),
],
```

---


## FASE 3: Crear un servicio para la API

En lugar de llamar a la API directamente desde el controlador, crearemos un servicio dedicado.

### 3.1. Crear la carpeta y la clase

Crea la carpeta `app/Services` si no existe y el archivo `PokemonApiService`.php:

```bash
mkdir -p app/Services
```

Crea app/Services/PokemonApiService.php con el siguiente contenido:
```php
<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Config;

class PokemonApiService
{
    private string $baseUrl;
    private int $timeout;

    public function __construct()
    {
        $this->baseUrl = rtrim(Config::get('services.pokeapi.base_url'), '/').'/';
        $this->timeout = Config::get('services.pokeapi.timeout', 5);
    }

    /**
     * Devuelve un listado paginado de pok√©mon.
     *
     * @param int $page P√°gina a mostrar (1, 2, 3...)
     * @param int $perPage N√∫mero de pok√©mon por p√°gina
     */
    public function getPokemonList(int $page = 1, int $perPage = 20): array
    {
        $offset = ($page - 1) * $perPage;

        try {
            $response = Http::timeout($this->timeout)
                ->get($this->baseUrl.'pokemon', [
                    'limit'  => $perPage,
                    'offset' => $offset,
                ]);

            if ($response->failed()) {
                Log::warning('Error al obtener listado de pok√©mon', [
                    'status' => $response->status(),
                    'body'   => $response->body(),
                ]);

                return [
                    'success' => false,
                    'error'   => 'No se ha podido obtener el listado de Pok√©mon.',
                    'data'    => [],
                ];
            }

            $data = $response->json();

            return [
                'success' => true,
                'data'    => [
                    'count'    => $data['count'] ?? 0,
                    'next'     => $data['next'] ?? null,
                    'previous' => $data['previous'] ?? null,
                    'results'  => $data['results'] ?? [],
                    'page'     => $page,
                    'perPage'  => $perPage,
                ],
            ];
        } catch (\Throwable $e) {
            Log::error('Excepci√≥n al llamar a Pok√©API', [
                'message' => $e->getMessage(),
            ]);

            return [
                'success' => false,
                'error'   => 'Error interno al contactar con la API.',
                'data'    => [],
            ];
        }
    }

    /**
     * Devuelve el detalle de un pok√©mon por nombre o id.
     */
    public function getPokemonDetail(string $nameOrId): array
    {
        try {
            $response = Http::timeout($this->timeout)
                ->get($this->baseUrl.'pokemon/'.$nameOrId);

            if ($response->failed()) {
                return [
                    'success' => false,
                    'error'   => 'Pok√©mon no encontrado o error en la API.',
                    'data'    => null,
                ];
            }

            return [
                'success' => true,
                'data'    => $response->json(),
            ];
        } catch (\Throwable $e) {
            Log::error('Excepci√≥n al obtener detalle de Pok√©mon', [
                'message' => $e->getMessage(),
            ]);

            return [
                'success' => false,
                'error'   => 'Error interno al contactar con la API.',
                'data'    => null,
            ];
        }
    }
}
```

> üí° Observa el patr√≥n: el servicio nunca lanza excepciones hacia arriba; siempre devuelve un array con `success`, `error` y `data`.

---

## FASE 4: Controlador y rutas
### 4.1. Crear el controlador

Crea un controlador `PokemonController`:

```bash
sail artisan make:controller PokemonController
```

Edita app/Http/Controllers/PokemonController.php:
```php
<?php

namespace App\Http\Controllers;

use App\Services\PokemonApiService;
use Illuminate\Http\Request;

class PokemonController extends Controller
{
    public function __construct(
        private readonly PokemonApiService $pokemonApi
    ) {
    }

    /**
     * Listado paginado de pok√©mon.
     */
    public function index(Request $request)
    {
        $page = (int) $request->get('page', 1);

        $result = $pokemonApiResult = $this->pokemonApi->getPokemonList($page, 20);

        if (! $result['success']) {
            return view('pokemon.index', [
                'error' => $result['error'],
                'pokemons' => [],
                'pagination' => null,
            ]);
        }

        $data = $result['data'];

        return view('pokemon.index', [
            'error' => null,
            'pokemons' => $data['results'],
            'pagination' => [
                'page'    => $data['page'],
                'perPage' => $data['perPage'],
                'total'   => $data['count'],
                'hasNext' => $data['next'] !== null,
                'hasPrev' => $data['previous'] !== null,
            ],
        ]);
    }

    /**
     * Detalle de un pok√©mon.
     */
    public function show(string $name)
    {
        $result = $this->pokemonApi->getPokemonDetail($name);

        if (! $result['success']) {
            return view('pokemon.show', [
                'error'   => $result['error'],
                'pokemon' => null,
            ]);
        }

        $pokemon = $result['data'];

        return view('pokemon.show', [
            'error'   => null,
            'pokemon' => $pokemon,
        ]);
    }
}
```

### 4.2. Definir las rutas

Edita `routes/web.php` y a√±ade al final:

```php
use App\Http\Controllers\PokemonController;

Route::get('/pokemon', [PokemonController::class, 'index'])
    ->name('pokemon.index');

Route::get('/pokemon/{name}', [PokemonController::class, 'show'])
    ->name('pokemon.show');
```

---

## FASE 5: Vistas Blade

Crea la carpeta de vistas:

```bash
mkdir -p resources/views/pokemon
```

### 5.1. Vista de listado (resources/views/pokemon/index.blade.php)

```blade
@extends('layouts.app')

@section('title', 'Listado de Pok√©mon')

@section('content')
<div class="container mx-auto py-8">
    <h1 class="text-3xl font-bold mb-6">Pok√©dex (API externa)</h1>

    @if ($error)
        <div class="bg-red-100 text-red-800 p-4 mb-4 rounded">
            {{ $error }}
        </div>
    @endif

    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        @forelse ($pokemons as $pokemon)
            <a href="{{ route('pokemon.show', basename($pokemon['url'])) }}"
               class="block border rounded-lg p-4 hover:shadow">
                <p class="font-semibold capitalize">{{ $pokemon['name'] }}</p>
                <p class="text-sm text-gray-500">
                    ID: {{ basename($pokemon['url']) }}
                </p>
            </a>
        @empty
            <p>No hay pok√©mon para mostrar.</p>
        @endforelse
    </div>

    @if ($pagination)
        <div class="mt-6 flex items-center gap-4">
            @if ($pagination['hasPrev'])
                <a href="{{ route('pokemon.index', ['page' => $pagination['page'] - 1]) }}"
                   class="px-4 py-2 border rounded">
                    ¬´ Anterior
                </a>
            @endif

            <span>P√°gina {{ $pagination['page'] }}</span>

            @if ($pagination['hasNext'])
                <a href="{{ route('pokemon.index', ['page' => $pagination['page'] + 1]) }}"
                   class="px-4 py-2 border rounded">
                    Siguiente ¬ª
                </a>
            @endif
        </div>
    @endif
</div>
@endsection
```

> Nota: para usar `layouts.app`, aseg√∫rate de tener un layout b√°sico (puedes reutilizar el de tu proyecto ‚ÄúMyShop‚Äù o crear uno muy simple).

### 5.2. Vista de detalle (`resources/views/pokemon/show.blade.php`)
```blade
@extends('layouts.app')

@section('title', 'Detalle Pok√©mon')

@section('content')
<div class="container mx-auto py-8">
    @if ($error)
        <div class="bg-red-100 text-red-800 p-4 mb-4 rounded">
            {{ $error }}
        </div>
        <a href="{{ route('pokemon.index') }}" class="underline text-blue-600">
            Volver al listado
        </a>
    @elseif ($pokemon)
        <div class="flex flex-col md:flex-row gap-6">
            <div>
                <img src="{{ $pokemon['sprites']['front_default'] ?? '' }}"
                     alt="{{ $pokemon['name'] }}"
                     class="w-40 h-40 object-contain bg-gray-100 rounded">
            </div>
            <div>
                <h1 class="text-3xl font-bold capitalize mb-2">
                    #{{ $pokemon['id'] }} - {{ $pokemon['name'] }}
                </h1>

                <p><strong>Altura:</strong> {{ $pokemon['height'] }} dm</p>
                <p><strong>Peso:</strong> {{ $pokemon['weight'] }} hg</p>

                <p class="mt-2">
                    <strong>Tipos:</strong>
                    @foreach ($pokemon['types'] as $type)
                        <span class="inline-block px-2 py-1 text-sm rounded bg-gray-200 mr-1">
                            {{ $type['type']['name'] }}
                        </span>
                    @endforeach
                </p>

                <h2 class="text-xl font-semibold mt-4 mb-2">Estad√≠sticas base</h2>
                <ul class="list-disc pl-5">
                    @foreach ($pokemon['stats'] as $stat)
                        <li>
                            {{ $stat['stat']['name'] }}:
                            {{ $stat['base_stat'] }}
                        </li>
                    @endforeach
                </ul>

                <a href="{{ route('pokemon.index') }}"
                   class="inline-block mt-4 underline text-blue-600">
                    Volver al listado
                </a>
            </div>
        </div>
    @else
        <p>No se ha podido cargar la informaci√≥n del Pok√©mon.</p>
        <a href="{{ route('pokemon.index') }}" class="underline text-blue-600">
            Volver al listado
        </a>
    @endif
</div>
@endsection
```

---


## FASE 6 (Opcional): Cachear las respuestas de la API

Para no llamar a la API cada vez, puedes usar `Cache`.

### 6.1. Cachear el detalle

Modifica `getPokemonDetail` en `PokemonApiService`:

```php
use Illuminate\Support\Facades\Cache;

// ...

public function getPokemonDetail(string $nameOrId): array
{
    try {
        $cacheKey = 'pokemon_detail_'.$nameOrId;

        $pokemon = Cache::remember($cacheKey, now()->addMinutes(10), function () use ($nameOrId) {
            $response = Http::timeout($this->timeout)
                ->get($this->baseUrl.'pokemon/'.$nameOrId);

            if ($response->failed()) {
                return null;
            }

            return $response->json();
        });

        if (! $pokemon) {
            return [
                'success' => false,
                'error'   => 'Pok√©mon no encontrado o error en la API.',
                'data'    => null,
            ];
        }

        return [
            'success' => true,
            'data'    => $pokemon,
        ];
    } catch (\Throwable $e) {
        // ...
    }
}
```


> üí° Esto a√±ade una capa realista de ‚Äúoptimizaci√≥n‚Äù muy t√≠pica cuando consumes APIs externas.

---

## Requisitos de entrega

Puedes definir algo del estilo (coherente con tus otras pr√°cticas):

- Captura 1: Listado de pok√©mon (`/pokemon?page=1`) funcionando.
- Captura 2: Listado de pok√©mon en otra p√°gina (`/pokemon?page=2`).
- Captura 3: Detalle de un pok√©mon (por ejemplo `/pokemon/pikachu`).
- Captura 4: Ejemplo de error controlado (por ejemplo `/pokemon/foobar`).
- Captura 5 (opcional): Evidencia de cache (por ejemplo, mostrando en `tinker` que existe la clave de cache or logs reducidos).

Y como entrega de c√≥digo:

- URL del repositorio (GitHub / GitLab) con el proyecto `PokeClient`.
- Instrucciones breves en el `README.md` para levantar la aplicaci√≥n con Sail.