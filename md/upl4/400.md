# Introducción

## Síntesis de la sesión

Esta sesión se enfoca en la interacción segura y eficiente entre la aplicación Laravel y los usuarios finales, dominando las técnicas más importantes para crear interfaces robustas y seguras. Se aprende a diseñar y gestionar **formularios HTML** seguros que protejan contra ataques como CSRF, implementando **validación** robusta de datos en múltiples capas. Se domina el **sistema de sesiones** para mantener el estado del usuario entre peticiones, implementando carritos de compra y notificaciones flash. Se implementa **autenticación completa** con Laravel Breeze para proteger rutas y recursos sensibles. Se explora el **almacenamiento de archivos** para gestionar imágenes de productos de forma segura. Se crean **middleware personalizados** para logging y validaciones específicas. Se comprende la coexistencia de **layouts tradicionales y componentes Blade** en proyectos reales. El objetivo es crear aplicaciones web completas y seguras que manejen la entrada del usuario de manera profesional.

## Contenidos de la Sesión 4

* **1. Formularios Seguros con Laravel** Se estudian los conceptos básicos de los formularios HTML y se crean formularios seguros usando las herramientas de Laravel, implementando protección CSRF automática y mejores prácticas de seguridad.
* **2. Sistema de Validación** Se domina el sistema de validación robusto de Laravel, aprendiendo a crear reglas personalizadas, manejar errores y proporcionar mensajes claros al usuario tanto en frontend como backend.
* **3. Manejo de Sesiones y Estado** Se gestionan sesiones de usuario y cookies para mantener el estado entre peticiones, implementando sistemas de notificaciones y manejo de errores elegantes.
* **4. Autenticación Básica** Se implementan sistemas de autenticación simples, aprendiendo sobre login, logout, registro de usuarios y protección de rutas sensibles.
* **5. Middleware Personalizado** Se crea middleware personalizado para aplicar lógica común como logging, rate limiting y validaciones específicas, manteniendo el código organizado y reutilizable.
* **6. Blade Components para Layouts** Se exploran las dos sintaxis de layouts en Laravel (tradicional con @extends y moderna con componentes), comprendiendo el concepto de $slot, slots nombrados, y cómo ambas sintaxis conviven en proyectos reales.
* **7. Sistema de Almacenamiento de Archivos** Se domina el sistema de almacenamiento de Laravel para gestionar archivos de forma segura. Se aprende a configurar discos de almacenamiento, crear enlaces simbólicos, validar y guardar archivos subidos, y eliminar archivos antiguos.
* **Diapositivas** Presentación completa de todos los conceptos de la sesión con diagramas, analogías y ejemplos visuales de la interacción usuario-aplicación.

## Objetivos de la Sesión 4

Acceso Rápido a los Objetivos

* **Objetivo 1**: Comprender los fundamentos de los formularios web y crear formularios seguros con Laravel, implementando protección CSRF y mejores prácticas de seguridad.
* **Objetivo 2**: Dominar el sistema de validación de Laravel, creando reglas personalizadas, validando archivos subidos y manejando errores de manera elegante tanto en frontend como backend.
* **Objetivo 3**: Gestionar sesiones y estado del usuario de manera segura, implementando carritos de compra, listas de deseos y sistemas de notificaciones flash.
* **Objetivo 4**: Implementar sistemas de autenticación completos con Laravel Breeze para proteger rutas y recursos sensibles, gestionando login, registro y logout.
* **Objetivo 5**: Crear middleware personalizado para aplicar lógica común como logging de actividad, rate limiting y validaciones específicas.
* **Objetivo 6**: Comprender la coexistencia de sintaxis tradicional (@extends) y moderna (componentes) en layouts Blade, entendiendo el concepto de $slot y slots nombrados.
* **Objetivo 7**: Dominar el sistema de almacenamiento de archivos de Laravel, configurando discos, creando enlaces simbólicos y gestionando archivos de forma segura.

---

---

| Objetivos Generales del Curso | Objetivos de la Sesión 4 |
| --- | --- |
| **Objetivo General 2** |**Objetivo 1**: Comprender formularios seguros | 
| **Objetivo General 2** |**Objetivo 2**: Dominar validación Laravel |
| **Objetivo General 2** |**Objetivo 3**: Gestionar sesiones y estado |
| **Objetivo General 2** |**Objetivo 4**: Implementar autenticación |
| **Objetivo General 2** |**Objetivo 5**: Crear middleware personalizado |
| **Objetivo General 2** |**Objetivo 6**: Comprender layouts Blade (tradicional vs componentes) |
| **Objetivo General 2** |**Objetivo 7**: Dominar almacenamiento de archivos |


## Recursos Adicionales

### Documentación Oficial

* [Laravel 12.x Documentation](https://laravel.com/docs/12.x){:target="_blank"} - Documentación oficial completa
* [Laravel Validation](https://laravel.com/docs/12.x/validation){:target="_blank"} - Guía oficial de validación
* [Laravel Authentication](https://laravel.com/docs/12.x/authentication){:target="_blank"} - Documentación oficial de autenticación
* [Laravel Middleware](https://laravel.com/docs/12.x/middleware){:target="_blank"} - Guía oficial de middleware
* [Laravel Blade Components](https://laravel.com/docs/12.x/blade#components){:target="_blank"} - Documentación de componentes Blade
* [Laravel File Storage](https://laravel.com/docs/12.x/filesystem){:target="_blank"} - Guía oficial de almacenamiento de archivos
* [Laravel Session](https://laravel.com/docs/12.x/session){:target="_blank"} - Documentación oficial de sesiones

### Seguridad Web

* [OWASP Top 10](https://owasp.org/www-project-top-ten/){:target="_blank"} - Principales vulnerabilidades web
* [CSRF Protection](https://owasp.org/www-community/attacks/csrf){:target="_blank"} - Información sobre protección CSRF
* [Web Security Best Practices](https://developer.mozilla.org/en-US/docs/Web/Security){:target="_blank"} - Mejores prácticas de seguridad web
* [Form Security](https://developer.mozilla.org/en-US/docs/Web/Security/Securing_your_site){:target="_blank"} - Seguridad en formularios

### Recursos de Aprendizaje

* [Laracasts](https://laracasts.com){:target="_blank"} - Tutoriales en video de Laravel
* [Laravel News](https://laravel-news.com){:target="_blank"} - Noticias y artículos sobre Laravel
* [Form Validation Best Practices](https://web.dev/sign-up-form-best-practices/){:target="_blank"} - Mejores prácticas de validación



???examplelaravel "Glosario Técnico"
	| Término | Definición |
	| --- | --- |
	| **Autenticación** | Proceso de verificar la identidad de un usuario (login/logout). |
	| **Autorización** | Proceso de determinar qué acciones puede realizar un usuario autenticado. |
	| **Componente Blade** | Clase reutilizable que encapsula lógica y vista para elementos de interfaz, con sintaxis moderna `<x-nombre>`. |
	| **Cookie** | Pequeño archivo de texto almacenado en el navegador del usuario para mantener información. |
	| **CSRF** | Cross-Site Request Forgery - ataque que explota la confianza de un sitio web en un usuario autenticado. |
	| **Disco de Almacenamiento** | Ubicación configurada donde Laravel guarda archivos (local, public, s3). |
	| **Enlace Simbólico** | "Portal" que conecta `public/storage` con `storage/app/public` para hacer archivos accesibles públicamente. |
	| **Formulario Web** | Elemento HTML que permite a los usuarios enviar datos al servidor de manera estructurada. |
	| **Laravel Breeze** | Paquete oficial de Laravel que implementa autenticación completa con vistas, controladores y rutas preconfiguradas. |
	| **Mensaje Flash** | Dato almacenado en sesión que solo persiste para la siguiente petición, útil para notificaciones. |
	| **Middleware** | Capa de software que procesa las peticiones HTTP antes de que lleguen a los controladores. |
	| **Rate Limiting** | Técnica que limita la frecuencia de peticiones para prevenir abuso. |
	| **Sanitización** | Proceso de limpiar y validar datos de entrada para prevenir ataques de inyección. |
	| **Sesión** | Mecanismo que permite mantener información del usuario entre múltiples peticiones HTTP. |
	| **Slot** | Variable especial en componentes Blade que representa el contenido pasado entre las etiquetas del componente. |
	| **Storage Facade** | Interfaz de Laravel para gestionar archivos (guardar, leer, eliminar) de forma consistente en diferentes discos. |
	| **Validación** | Proceso de verificar que los datos ingresados cumplen con los criterios especificados. |



???examplelaravel "FAQ (Preguntas Frecuentes sobre la Práctica)"
	* ==**P: ¿Por qué es importante la protección CSRF en los formularios?**==
	+ **R:** CSRF protege contra ataques donde un sitio malicioso realiza acciones en nombre del usuario autenticado sin su conocimiento, explotando la confianza del navegador.
  
	* ==**P: ¿Cuál es la diferencia entre validación del frontend y backend?**==
	+ **R:** La validación del frontend mejora la experiencia del usuario con feedback inmediato, pero la validación del backend es esencial para la seguridad y debe ser la fuente de verdad.
	* ==**P: ¿Cómo funciona el sistema de validación de Laravel?**==
	+ **R:** Laravel proporciona reglas de validación predefinidas y permite crear reglas personalizadas, devolviendo errores estructurados que se pueden mostrar fácilmente al usuario.
	* ==**P: ¿Qué son las sesiones y por qué son importantes?**==
	+ **R:** Las sesiones permiten mantener información del usuario entre peticiones HTTP (que es stateless), esencial para funcionalidades como carritos de compra o estados de login.
	* ==**P: ¿Cuándo debo usar middleware personalizado?**==
	+ **R:** Cuando necesitas aplicar la misma lógica a múltiples rutas (logging, autenticación, rate limiting) o cuando quieres mantener el código organizado y reutilizable.
	* ==**P: ¿Cómo puedo mejorar la seguridad de mis formularios?**==
	+ **R:** Usando protección CSRF, validación robusta, sanitización de datos, rate limiting, y siguiendo las mejores prácticas de OWASP para formularios web.
	* ==**P: ¿Qué es la diferencia entre autenticación y autorización?**==
	+ **R:** La autenticación verifica "quién eres" (login), mientras que la autorización determina "qué puedes hacer" (permisos y roles).
	* ==**P: Error "Las imágenes no se muestran en el navegador" después de subirlas**==
	+ **R:** Verifica los siguientes pasos:

		1. Ejecutaste `sail artisan storage:link` para crear el enlace simbólico
		2. El archivo se guardó en `storage/app/public/products/` con `store('products', 'public')`
		3. En la vista usas `asset('storage/' . $product->image)` (no `asset('public/storage/...')`)
		4. Los permisos del directorio `storage/app/public` permiten lectura (755)
		5. Verifica que el archivo existe con `ls -la storage/app/public/products/`
		
	* ==**P: Error "419 Page Expired" al enviar formularios después de instalar Breeze**==
	+ **R:** Verifica los siguientes pasos:
		
		1. Todos los formularios tienen la directiva `@csrf` dentro de la etiqueta `<form>`
		2. Limpia la caché con `sail artisan config:clear` y `sail artisan cache:clear`
		3. Borra las cookies del navegador para `localhost`
		4. Verifica que `.env` tiene `APP_KEY` generada (ejecuta `sail artisan key:generate` si no)
		5. Recarga la página con Ctrl+F5 (o Cmd+Shift+R en Mac) para limpiar caché del navegador.
 		  
	* ==**P: ¿Por qué tengo dos sintaxis de layouts diferentes (@extends y `<x-app-layout>`)?**==
	+ **R:** Es completamente normal en proyectos que integran Laravel Breeze:
		
		1. Las páginas públicas usan `@extends('layouts.public')` (layout que creaste en prácticas anteriores)
		2. Las páginas de administración usan `<x-app-layout>` (layout generado automáticamente por Breeze)
		3. Ambas sintaxis son válidas y pueden coexistir en el mismo proyecto
		4. Breeze usa componentes Blade (sintaxis moderna), mientras que tu layout público usa sintaxis tradicional
		5. En proyectos nuevos, se recomienda elegir una sintaxis, pero en proyectos existentes es normal tener ambas

	* ==**P: Error "Call to undefined method store()" al subir archivos**==
	+ **R:** Verifica los siguientes pasos:

    1. El formulario tiene `enctype="multipart/form-data"` en la etiqueta `<form>`
    2. El campo input es de tipo `file`: `<input type="file" name="image">`
    3. Usas `$request->file('image')` (no `$request->input('image')`)
    4. Validas el archivo con `'image' => 'required|image|mimes:jpeg,png,jpg|max:2048'`
    5. Importaste la facade `use Illuminate\Support\Facades\Storage;` si usas métodos de Storage
	* ==**P: Los datos del carrito se pierden al cerrar el navegador**==
	+ **R:** Esto es el comportamiento esperado de las sesiones:
	
		1. Las sesiones por defecto expiran cuando se cierra el navegador
		2. 1. Si quieres persistencia, debes usar la tabla `product_user` (como en la wishlist)
		3. El carrito usa sesiones porque es temporal y debe vaciarse tras la compra
		4. La wishlist usa base de datos porque es permanente y debe persistir entre sesiones
		5. Para extender el tiempo de sesión, modifica `SESSION_LIFETIME` en `.env` (en minutos)
	* ==**P: ¿Cómo depuro errores en los middleware personalizados?**==
	+ **R:** Usa estas técnicas:
	
		1. Añade `Log::info('Mensaje de debug', ['data' => $variable])` en el middleware
		2. Revisa los logs con `tail -f storage/logs/laravel.log`
		3. Usa `dd($request->all())` para ver qué recibe el middleware
		4. Verifica que el middleware está registrado en `bootstrap/app.php`
		5. Comprueba que se aplica a las rutas correctas con `sail artisan route:list`

## 🏆 Hitos a Conseguir

> Al completar esta sesión, habrás creado una **aplicación web completa y segura con Laravel** que incluya:
>
> * **Sistema de autenticación completo** con Laravel Breeze (login, registro, logout)
> * **Formularios seguros** con protección CSRF y validación robusta en múltiples capas
> * **CRUD completo de productos** con formularios de creación, edición y eliminación protegidos
> * **Sistema de almacenamiento de archivos** para gestionar imágenes de productos de forma segura
> * **Carrito de compras funcional** con gestión de sesiones
> * **Lista de deseos (wishlist)** persistente en base de datos para usuarios autenticados
> * **Middleware personalizado** para logging de actividad de administradores
> * **Mensajes flash** para feedback consistente al usuario
> * **Panel de administración** protegido con middleware de autenticación
> * **Separación de layouts** públicos (sintaxis tradicional) y privados (componentes Blade)
> * **Validación de archivos** con tipos MIME y tamaños máximos
> * **Manejo elegante de errores** con mensajes personalizados en español
>
> **Resultado:** Una aplicación de tienda online profesional, segura y completamente funcional que maneja de forma robusta la interacción con el usuario, desde la navegación pública hasta la gestión administrativa, demostrando el dominio de las técnicas fundamentales de desarrollo web seguro con Laravel.
