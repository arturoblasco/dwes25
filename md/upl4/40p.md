# Práctica guiada

## Objetivo

El objetivo de esta práctica es completar la tienda online implementando un sistema completo de autenticación de usuarios, formularios seguros con protección CSRF, validación robusta de datos, manejo de sesiones y middleware personalizado. Esta es la práctica final que hará que la aplicación sea 100% funcional, segura y lista para producción.

### Filosofía de trabajo

Esta práctica representa la culminación del proyecto de tienda online iniciado en la Práctica 1. Se integrarán todas las funcionalidades aprendidas (rutas, controladores, vistas, modelos, relaciones) añadiendo la capa de seguridad y gestión de usuarios necesaria para una aplicación web profesional.

#### Continuación de la Práctica 3

Esta práctica está basada en la tienda online con **persistencia de datos real** creada en la **Práctica 3**. Se añadirá autenticación de usuarios, formularios seguros y protección de rutas para completar la funcionalidad CRUD.

- **Base de Datos**: Se utilizará MySQL a través de Laravel Sail con los modelos Eloquent ya creados (Product, Category, Offer, User).

- **Funcionalidad**: Los usuarios autenticados podrán crear, editar y eliminar productos. Los usuarios no autenticados solo podrán ver los productos.

---

## FASE 1: Verificar el Eetado del proyecto

### 1. Arrancar los contenedores de Laravel Sail

Antes de comenzar, asegúrate de que el entorno de desarrollo esté funcionando correctamente.

???+questionlaravel "Arrancar contenedor de laravel sail:"
    ```bash
    sail up -d
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail up -d
        
        [+] Running 3/3
        ✔ Container myshop-mysql-1        Running                          0.0s
        ✔ Container myshop-redis-1        Running                          0.0s
        ✔ Container myshop-laravel.test-1 Running                          0.0s
        ```

### 2. Verificar que la aplicación funciona

Abre tu navegador y accede a la URL `http://localhost` (deberías ver tu tienda online con los productos, categorías y ofertas funcionando correctamente desde la Práctica 3).

> **Importante**
> 
> Si la aplicación no funciona correctamente, revisa que:
> 
> * Los contenedores Docker estén ejecutándose (`sail ps`).
> * La base de datos tenga datos (ejecuta `sail artisan db:seed` si es necesario).
> * Las migraciones estén aplicadas (`sail artisan migrate:status`).

### 3. Verificar las rutas actuales

Antes de añadir autenticación, vamos a ver qué rutas tiene nuestra aplicación actualmente.

???+questionlaravel "Ejecuta"
    ```bash
    sail artisan route:list
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan route:list

        GET|HEAD        / .................................. welcome › WelcomeController@index
        GET|HEAD        cart ............................... cart.index › CartController@index
        POST            cart ............................... cart.store › CartController@store
        PUT             cart/{id} ........................ cart.update › CartController@update
        GET|HEAD        categories ............... categories.index › CategoryController@index
        GET|HEAD        categories/{id} ............ categories.show › CategoryController@show
        GET|HEAD        contact ...................................................... contact
        GET|HEAD        offers .......................... offers.index › OfferController@index
        GET|HEAD        offers/{offer} .................... offers.show › OfferController@show
        GET|HEAD        products .................... products.index › ProductController@index
        POST            products .................... products.store › ProductController@store
        GET|HEAD        products-on-sale ......... products.on-sale › ProductController@onSale
        GET|HEAD        products/create ........... products.create › ProductController@create
        GET|HEAD        products/{product} ............ products.show › ProductController@show
        PUT|PATCH       products/{product} ........ products.update › ProductController@update
        DELETE          products/{product} ...... products.destroy › ProductController@destroy
        GET|HEAD        products/{product}/edit ....... products.edit › ProductController@edit
        GET|HEAD        storage/{path} ......................................... storage.local
        
        # Otras rutas telescope ....
        ```

**Estado actual de las rutas CRUD**

Actualmente, **todas las rutas son públicas**. Además, en el listado aparecen rutas como `products.create`, `products.store`, `products.edit`, `products.update` y `products.destroy`.

Estas rutas fueron definidas en la Práctica 3, pero **sus métodos en el controlador aún NO están completamente implementados** (solo redirigen con mensajes simulados). En esta práctica completaremos su implementación para que sean completamente funcionales.



## FASE 2: Preparar layouts para separación pública/privada

En esta sesión vamos a implementar un sistema de login y registro utilizando **Laravel Breeze**. Antes de instalar esta librería, es fundamental reorganizar nuestros layouts existentes para evitar conflictos.

### 1. ¿Por qué separar los layouts?

Laravel Breeze crea automáticamente un layout llamado `app.blade.php` para áreas autenticadas (dashboard, perfil, administración). Sin embargo, ya tenemos un `app.blade.php` diseñado específicamente para nuestra **tienda pública**.

> ⚠️ **Conflicto inminente**
> 
> Si instalamos Breeze sin preparar los layouts, **sobrescribirá nuestro archivo actual**, perdiendo todo el diseño de la tienda pública.

### 2. Renombrar el layout

Vamos a crear **dos layouts independientes**, cada uno optimizado para su propósito:

| Layout | Propósito | Características | Usado por |
| --- | --- | --- | --- |
| `public.blade.php` | **Tienda pública** | Navegación de productos, footer e-commerce | Visitantes no autenticados |
| `app.blade.php` | **Área de administración** | Dashboard, menú de usuario, enlaces admin | Usuarios autenticados |

Vamos a renombrar el archivo `app.blade.php` a `public.blade.php` para que contenga el diseño de la tienda pública.

???+questionlaravel "Ejecuta:"
    ```bash
    mv resources/views/layouts/app.blade.php resources/views/layouts/public.blade.php
    ```

### 3. Actualizar las vistas públicas

Ahora vamos a actualizar todas las vistas públicas para que usen el nuevo nombre del layout.

**Vistas a actualizar:**

1. `resources/views/welcome.blade.php` (página principal).
2. `resources/views/contact.blade.php` (página contacto).
3. `resources/views/cart/index.blade.php` (carrito de compras).
4. `resources/views/categories/index.blade.php` (productos por categoría).
5. `resources/views/categories/show.blade.php` (productos por categoría).
6. `resources/views/offers/index.blade.php` (productos en oferta).
7. `resources/views/offers/show.blade.php` (productos en oferta).
8. `resources/views/products/index.blade.php` (listado de productos).
9. `resources/views/products/show.blade.php` (detalle de producto).

???+questionlaravel "Modifica"
    Para cada una de estas vistas, busca la línea:
    ```php
    @extends('layouts.app')
    ```

    Y cámbiala por:
    ```php
    @extends('layouts.public')
    ```

    ???examplelaravel "Forma rápida (con comandos) para Linux:"

        El comando `sed` es una herramienta de Linux para buscar y reemplazar texto en archivos. Es más rápido que editar cada archivo manualmente.
        ```bash
        # Actualizar welcome.blade.php
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/welcome.blade.php

        # Actualizar contact.blade.php
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/contact.blade.php

        # Actualizar vistas de carrito (si existe)
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/cart/index.blade.php 2>/dev/null || true

        # Actualizar vistas de categorías
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/categories/index.blade.php 2>/dev/null || true
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/categories/show.blade.php

        # Actualizar vistas de ofertas
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/offers/index.blade.php 2>/dev/null || true
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/offers/show.blade.php 2>/dev/null || true

        # Actualizar vistas de productos
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/products/index.blade.php
        sed -i "s/@extends('layouts.app')/@extends('layouts.public')/g" resources/views/products/show.blade.php
        ```

    ???examplelaravel "Verificar cambios en archivos"
        Después de ejecutar los comandos, puedes verificar que los archivos se han actualizado correctamente con:
        ```bash
        grep -H "@extends('layouts.public')" resources/views/welcome.blade.php resources/views/contact.blade.php resources/views/cart/index.blade.php resources/views/categories/index.blade.php resources/views/categories/show.blade.php resources/views/offers/index.blade.php resources/views/offers/show.blade.php resources/views/products/index.blade.php resources/views/products/show.blade.php
        ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        resources/views/welcome.blade.php:@extends('layouts.public')
        resources/views/contact.blade.php:@extends('layouts.public')
        resources/views/cart/index.blade.php:@extends('layouts.public')
        resources/views/categories/index.blade.php:@extends('layouts.public')
        resources/views/categories/show.blade.php:@extends('layouts.public')
        resources/views/offers/index.blade.php:@extends('layouts.public')
        resources/views/offers/show.blade.php:@extends('layouts.public')
        resources/views/products/index.blade.php:@extends('layouts.public')
        resources/views/products/show.blade.php:@extends('layouts.public')
        ```

### 4. Verificar que la aplicación sigue funcionando

Después de renombrar el layout y actualizar las vistas, vamos a verificar que todo funciona correctamente.

1. **Visita** `http://localhost` en tu navegador.  
2. **Verifica** que la página principal se muestra correctamente.  
3. **Navega** por diferentes secciones:  Listado de productos, Detalle de un producto y Productos por categoría.  
4. **Comprueba** que el diseño se mantiene igual (navegación, footer, estilos).

???praclaravel "Captura de pantalla requerida"

    Realiza una captura de pantalla mostrando:

    1. La página principal funcionando correctamente después del cambio.
    2. Tu terminal con el comando `ls -l resources/views/layouts/` visible, mostrando que existe `public.blade.php`

## FASE 3: Instalar y configurar Laravel Breeze

### 1. ¿Qué es Laravel Breeze?

Laravel Breeze es un kit de inicio de autenticación minimalista que proporciona una implementación completa de:

* **Registro de usuarios** con validación.
* **Login y logout** con sesiones.
* **Recuperación de contraseña** con emails.
* **Verificación de email** (opcional).
* **Actualización de perfil** y contraseña.
* **Vistas Blade** prediseñadas con Tailwind CSS.
* **Rutas protegidas** con middleware.

Breeze es perfecto para proyectos que necesitan autenticación básica sin complejidad innecesaria.

> **Alternativas a Breeze**
> 
> Laravel también ofrece:
> 
> * **Jetstream**: Más completo con equipos, 2FA y API tokens.
> * **Fortify**: Backend de autenticación sin vistas.
> * **Sanctum**: Autenticación API para SPAs y aplicaciones móviles.

&nbsp;

> Para esta práctica, Breeze es ideal porque es simple y usa Blade (que ya conocemos).

### 2. Instalar Laravel Breeze

Laravel Breeze se instala como una dependencia de desarrollo porque solo se necesita durante la configuración inicial.

???+questionlaravel "Ejecuta el siguiente comando para instalar Breeze"
    ```bash
    sail composer require laravel/breeze --dev
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail composer require laravel/breeze --dev
        .........

        INFO  No publishable resources for tag [laravel-assets].

        No security vulnerability advisories found.
        Using version ^2.3 for laravel/breeze
        ```

### 3. Instalar el stack de autenticación Blade

Ahora vamos a instalar el "stack" de Breeze con Blade. Esto generará:

* Controladores de autenticación.
* Rutas de autenticación.
* Vistas Blade para login, registro, recuperación de contraseña, etc.
* Migraciones para tablas de autenticación.

> ⚠️ Importante: **Breeze sobrescribirá algunos archivos**
> 
> Laravel Breeze **reemplazará** `routes/web.php` → Perderás todas tus rutas (productos, categorías, ofertas).

&nbsp;

> No te preocupes, en la **FASE 5** restauraremos todas tus rutas de la tienda.

???+questionlaravel "Ejecuta:"
    ```bash
    sail artisan breeze:install blade
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan breeze:install blade

        INFO  Installing and building Node dependencies.


        added 104 packages, changed 1 package, and audited 260 packages in 5s

        58 packages are looking for funding
        run `npm fund` for details

        found 0 vulnerabilities

        > build
        > vite build

        vite v7.1.9 building for production...
        ✓ 54 modules transformed.
        public/build/manifest.json             0.31 kB │ gzip:  0.16 kB
        public/build/assets/app-CFHRtieK.css  44.38 kB │ gzip:  7.91 kB
        public/build/assets/app-CXDpL9bK.js   80.59 kB │ gzip: 30.19 kB
        ✓ built in 1.23s


        INFO  Breeze scaffolding installed successfully.
        ```

### 4. Instalar Dependencias de NPM

Breeze requiere compilar assets CSS y JavaScript. 

Vamos a instalar las dependencias y compilar los assets.

???+questionlaravel "Ejecuta"
    ```bash
    sail npm install
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail npm install

        added 67 packages, and audited 260 packages in 853ms

        58 packages are looking for funding
        run `npm fund` for details

        found 0 vulnerabilities
        ```

???+questionlaravel "Ahora compila los assets para producción"
    ```bash
    sail npm run build
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail npm run build

        > build
        > vite build

        vite v5.4.8 building for production...
        ✓ 89 modules transformed.
        public/build/manifest.json                   1.48 kB │ gzip:  0.38 kB
        public/build/assets/app-C2nBmIGE.css         7.52 kB │ gzip:  2.11 kB
        public/build/assets/app-BmZ5zMLg.js        120.44 kB │ gzip: 46.52 kB
        ✓ built in 2.14s
        ```

> **Por qué usar `npm run build`**
> 
> Para esta práctica, usaremos `build` porque no vamos a modificar los estilos de Breeze.

### 5. Verificar las nuevas rutas de autenticación

Breeze ha añadido automáticamente nuevas rutas para autenticación. 

???+questionlaravel "Verificar rutas"
    ```bash
    sail artisan route:list | grep -E "(login|register|logout)"
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan route:list | grep -E "(login|register|logout)"

        GET|HEAD  login .................. login › Auth\AuthenticatedSessionController@create
        POST      login .................. Auth\AuthenticatedSessionController@store
        POST      logout ................. logout › Auth\AuthenticatedSessionController@destroy
        GET|HEAD  register ............... register › Auth\RegisteredUserController@create
        POST      register ............... Auth\RegisteredUserController@store
        ```

**Rutas de autenticación añadidas**

Breeze ha creado automáticamente las siguientes rutas:

* **GET /register**: formulario de registro.
* **POST /register**: procesar registro.
* **GET /login**: formulario de login.
* **POST /login**: procesar login.
* **POST /logout**: cerrar sesión.
* **GET /forgot-password**: recuperación de contraseña.
* **GET /dashboard**: panel de control para usuarios autenticados.

### 6. Probar las páginas de autenticación

Vamos a verificar que las páginas de autenticación funcionen correctamente.

Abre tu navegador y visita:

1. **Registro**: `http://localhost/register`
2. **Login**: `http://localhost/login`

Deberías ver formularios estilizados con Tailwind CSS listos para usar.

???praclaravel "Captura de pantalla requerida"

    Realiza una captura de pantalla de las páginas de **registro** y **login** funcionando correctamente. 
    
    Incluye tu terminal con el prompt `usuario@equipo:~/ruta/proyecto$` visible mostrando el comando `sail artisan route:list` con las rutas de autenticación.



## FASE 4: Crear un usuario de prueba

### 1. Registrar un usuario manualmente

La forma más sencilla de crear un usuario es usar el formulario de registro que acabamos de instalar.

Visita `http://localhost/register` y completa el formulario con:

* **Name**: Tu Nombre
* **Email**: [tu@email.com](mailto:tu@email.com)
* **Password**: password123
* **Confirm Password**: password123

Haz clic en "Register" y serás redirigido al dashboard (`/dashboard`).

**¿Qué pasa cuando te registras?**

Cuando completas el formulario de registro, Laravel:

1. **Valida los datos** (nombre requerido, email único, contraseña mínimo 8 caracteres).
2. **Hashea la contraseña** con bcrypt (nunca se guarda en texto plano).
3. **Crea el usuario** en la tabla `users`.
4. **Inicia sesión automáticamente** y guarda el ID del usuario en la sesión.
5. **Redirige al dashboard** (`/dashboard`).

### 2. Crear Usuarios desde Tinker (Opcional)

También puedes crear usuarios directamente desde la consola usando Tinker.

???+questionlaravel "Ejecuta:"
    ```bash
    sail artisan tinker
    ```

???+questionlaravel "Dentro de Tinker, ejecuta"
    ```php
    $user = App\Models\User::create([
        'name' => 'Administrador',
        'email' => 'admin@tienda.com',
        'password' => bcrypt('password123')
    ]);
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan tinker
        Psy Shell v0.12.4 (PHP 8.3.13 — cli) by Justin Hileman

        > $user = App\Models\User::create(['name' => 'Administrador', 'email' => 'admin@tienda.com', 'password' => bcrypt('password123')]);
        = App\Models\User {#5960
            name: "Administrador",
            email: "admin@tienda.com",
            #password: "$2y$12$LMJCds5Eu1n5znSeJlnw2Ohuqhip9RHBy0LIym1xBxvkN737A/OzK",
            updated_at: "2025-10-08 07:27:05",
            created_at: "2025-10-08 07:27:05",
            id: 5,
        }
        ```

> **Contraseñas hasheadas**
> 
> Observa que la contraseña no aparece en texto plano. Laravel usa **bcrypt** para hashear las contraseñas, lo que las hace prácticamente imposibles de descifrar.
> 
> Para salir de Tinker, escribe `exit` o presiona `Ctrl+D`.

### 3. Verificar los usuarios creados

Vamos a verificar que los usuarios se hayan creado correctamente en la base de datos.

???+questionlaravel "Conéctate a MySQL"
    ```bash
    sail mysql
    ```

???+questionlaravel "Ejecuta"
    ```sql
    USE myshop;
    SELECT id, name, email, created_at FROM users;
    exit;
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail mysql
        mysql> USE myshop;
        Database changed

        mysql> SELECT id, name, email, created_at FROM users;
        +----+--------------------------+----------------------------+---------------------+
        | id | name                     | email                      | created_at          |
        +----+--------------------------+----------------------------+---------------------+
        |  1 | Usuario Demo             | demo@example.com           | 2025-10-07 19:57:51 |
        |  2 | Ariel Nikolaus           | eloy.roob@example.org      | 2025-10-07 19:57:51 |
        |  3 | Dandre Thiel             | casimer63@example.com      | 2025-10-07 19:57:51 |
        |  4 | Guillermo Garrido Portes | g.garridoportes@edu.gva.es | 2025-10-08 07:25:45 |
        |  5 | Administrador            | admin@tienda.com           | 2025-10-08 07:27:05 |
        +----+--------------------------+----------------------------+---------------------+
        5 row in set (0.00 sec)

        mysql> exit;
        Bye
        ```



## FASE 5: Proteger rutas y definir la arquitectura Admin

### 1. ¿Qué es el Middleware de Autenticación?

El middleware **`auth`** es un "filtro" que Laravel aplica a las rutas para verificar si el usuario está autenticado. Si no lo está, lo redirige automáticamente a la página de login. En esta fase, protegeremos las rutas de administración (crear, editar, eliminar productos) para que solo los usuarios autenticados puedan acceder a ellas.

**Tipos de rutas**:

* **Públicas**: Cualquiera puede acceder (ver productos, categorías). Usan `products.index`, `products.show`, etc.
* **Protegidas**: Solo usuarios autenticados pueden acceder. Crearemos rutas específicas como `admin.products.index` para la gestión.

### 2. Actualizar el archivo de rutas (`web.php`)

Vamos a reorganizar **`routes/web.php`** para definir todas las rutas que necesitaremos: las públicas, las de perfil/dashboard de Breeze, y las nuevas rutas de administración para gestionar la tienda.

**Restaurando y Organizando las Rutas**

Como explicamos en la FASE 3, Breeze sobrescribió tu archivo `routes/web.php`. Ahora vamos a restaurar las rutas de las prácticas anteriores y a añadir las nuevas rutas de administración.

???+questionlaravel "Reemplaza código:"
    Abre el archivo `routes/web.php` y reemplaza todo su contenido con el siguiente código:

    ```php
    <?php

    use Illuminate\Support\Facades\Route;
    use App\Http\Controllers\ProductController;
    use App\Http\Controllers\CategoryController;
    use App\Http\Controllers\OfferController;
    use App\Http\Controllers\ProfileController;
    use App\Http\Controllers\WelcomeController;
    use App\Http\Controllers\CartController;

    /*
    |--------------------------------------------------------------------------
    | Web Routes
    |--------------------------------------------------------------------------
    */

    // ===========================================
    // RUTAS PÚBLICAS (Sin autenticación requerida)
    // ===========================================

    // Welcome page - shows home page with featured content
    Route::get('/', [WelcomeController::class, 'index'])->name('welcome');

    // Contact page
    Route::get('/contact', function () {
        return view('contact');
    })->name('contact');

    // Rutas de categorías (solo lectura)
    Route::resource('categories', CategoryController::class)->only(['index', 'show']);

    // Rutas de productos (solo lectura)
    Route::get('/products-on-sale', [ProductController::class, 'onSale'])->name('products.on-sale');
    Route::resource('products', ProductController::class)->only(['index', 'show']);

    // Rutas de ofertas (solo lectura)
    Route::resource('offers', OfferController::class)->only(['index', 'show']);

    // Rutas básicas del carrito de compras
    // NOTA: Las rutas avanzadas (update, destroy, checkout) se añadirán en FASE 10
    Route::get('/cart', [CartController::class, 'index'])->name('cart.index');
    Route::post('/cart', [CartController::class, 'store'])->name('cart.store');

    // ===========================================
    // RUTAS DE USUARIO AUTENTICADO (Breeze)
    // ===========================================

    Route::middleware('auth')->group(function () {
        // Dashboard
        Route::get('/dashboard', function () {
            return view('dashboard');
        })->name('dashboard');

        // Perfil de usuario
        Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
        Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
        Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
    });


    // ===========================================
    // RUTAS DE ADMINISTRACIÓN (Protegidas)
    // ===========================================

    Route::middleware('auth')->prefix('admin')->name('admin.')->group(function () {
        // Rutas de gestión de productos
        Route::get('/products', [ProductController::class, 'adminIndex'])->name('products.index');
        Route::resource('products', ProductController::class)->except(['index', 'show']);

        // NOTA: Las rutas de wishlist se añadirán en FASE 11
    });

    // Las rutas de autenticación (login, register, etc.) se incluyen desde aquí
    require __DIR__.'/auth.php';
    ```

**Estructura de rutas de Administración**

Observa el nuevo grupo de rutas con **`prefix('admin')`** y **`name('admin.')`**:

* **`prefix('admin')`**: añade `/admin/` a la URL de todas las rutas del grupo (ej: `/admin/products`).
* **`name('admin.')`**: añade `admin.` al nombre de todas las rutas del grupo (ej: `admin.products.index`).
* **`middleware('auth')`**: por ahora solo protegemos con autenticación. En FASE 12 añadiremos middleware de logging.
* **`adminIndex`**: usaremos este nuevo método en los controladores para mostrar la tabla de gestión.
* **`except(['index', 'show'])`**: reutilizamos el `resource` para las rutas `create`, `store`, `edit`, `update` y `destroy`, pero excluimos `index` y `show` que ya usamos para la parte pública.

> En este punto deberías tener todas las rutas necesarias definidas correctamente. Puedes probar a navegar por la tienda pública y verificar que las rutas funcionan.

### 3. Añadir enlaces de administración al menú de navegación

Ahora para llegar desde la tienda pública al login o registro, necesitamos una forma de navegar a ella. Para ello, vamos a añadir un enlace en el menú de navegación en `partials/navigation.blade.php`.

???+questionlaravel "Añadir código en `navigation.blade.php`"
    Abre el archivo `resources/views/partials/navigation.blade.php` y añade el enlace de login o registro (reemplaza el código):

    ```html
    <nav class="hidden md:flex space-x-8">
        <a href="{{ route('welcome') }}" 
        class="text-gray-700 hover:text-primary-600 transition {{ request()->routeIs('welcome') ? 'text-primary-600 font-semibold' : '' }}">
            Inicio
        </a>
        <a href="{{ route('products.index') }}" 
        class="text-gray-700 hover:text-primary-600 transition {{ request()->routeIs('products.*') ? 'text-primary-600 font-semibold' : '' }}">
            Productos
        </a>
        <a href="{{ route('categories.index') }}" 
        class="text-gray-700 hover:text-primary-600 transition {{ request()->routeIs('categories.*') ? 'text-primary-600 font-semibold' : '' }}">
            Categorías
        </a>
        <a href="{{ route('offers.index') }}" 
        class="text-gray-700 hover:text-primary-600 transition {{ request()->routeIs('offers.*') ? 'text-primary-600 font-semibold' : '' }}">
            Ofertas
        </a>
        <a href="{{ route('contact') }}" 
        class="text-gray-700 hover:text-primary-600 transition {{ request()->routeIs('contact') ? 'text-primary-600 font-semibold' : '' }}">
            Contacto
        </a>
        @auth
            <a href="{{ route('dashboard') }}" 
            class="text-gray-700 hover:text-primary-600 transition {{ request()->routeIs('dashboard') ? 'text-primary-600 font-semibold' : '' }}">
                Dashboard
            </a>
        @endauth
        @guest
            <a href="{{ route('login') }}" 
            class="text-gray-700 hover:text-primary-600 transition {{ request()->routeIs('login') ? 'text-primary-600 font-semibold' : '' }}">
                Login
            </a>
        @endguest
    </nav>
    ```

**Directiva `@auth` y `@guest`**

La directiva **`@auth`** de Blade es un condicional que solo renderiza el bloque de código si el usuario actual está autenticado. 

La directiva **`@guest`** es un condicional que solo renderiza el bloque de código si el usuario actual no está autenticado.



## FASE 6: Configurar el sistema de almacenamiento de archivos

Antes de crear el formulario de productos, necesitamos preparar Laravel para manejar la carga de archivos de forma segura.

### 1. Crear el enlace simbólico

Para que las imágenes guardadas en `storage/app/public` sean accesibles desde la web, 

???+questionlaravel "ejecuta"
    ```bash
    sail artisan storage:link
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan storage:link

        INFO  The [public/storage] link has been connected to [storage/app/public].
        ```

Ahora, cualquier archivo en `storage/app/public/products/imagen.jpg` será accesible como `http://localhost/storage/products/imagen.jpg`.

### 2. Añadir el campo de imagen a la tabla de products

Necesitamos una columna en la base de datos para guardar la ruta de la imagen de cada producto.

???+questionlaravel "Crea una nueva migración"
    ```bash
    sail artisan make:migration add_image_to_products_table --table=products
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan make:migration add_image_to_products_table --table=products

        INFO  Migration [database/migrations/2025_10_17_120345_add_image_to_products_table.php] created successfully.
        ```

???+questionlaravel "Añade código en el archivo de migración"
    Abre el archivo de migración recién creado (`2025_10_19_144009_add_image_to_products_table.php`) y añade la columna:

    ```php
    <?php

    use Illuminate\Database\Migrations\Migration;
    use Illuminate\Database\Schema\Blueprint;
    use Illuminate\Support\Facades\Schema;

    return new class extends Migration
    {
        /**
        * Run the migrations.
        */
        public function up(): void
        {
            Schema::table('products', function (Blueprint $table) {
                $table->string('image')->nullable()->after('description');
            });
        }

        /**
        * Reverse the migrations.
        */
        public function down(): void
        {
            Schema::table('products', function (Blueprint $table) {
                $table->dropColumn('image');
            });
        }
    };
    ```

**Por qué `nullable()`**

Hacemos la columna `nullable()` para que los productos existentes no generen errores. Además, así podemos crear productos sin imagen si es necesario.

???+questionlaravel "Ejecuta la migración"
    ```bash
    sail artisan migrate
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan migrate

        INFO  Running migrations.

        2025_10_17_131336_add_image_to_products_table ............ 28ms DONE
        ```

### 3. Actualizar el modelo `Product` para permitir el campo `image`

???+questionlaravel "Añadir campo `image` a `Product.php`"
    Abre `app/Models/Product.php` y añade `'image'` al array `$fillable`:
    dl
    ```php
    <?php

    namespace App\Models;

    use Illuminate\Database\Eloquent\Casts\Attribute;
    use Illuminate\Database\Eloquent\Factories\HasFactory;
    use Illuminate\Database\Eloquent\Model;
    use Illuminate\Database\Eloquent\Relations\BelongsTo;
    use Illuminate\Database\Eloquent\Relations\BelongsToMany;

    class Product extends Model
    {
        use HasFactory;

        protected $fillable = [
            'name',
            'description',
            'image',   // Añadimos el campo de imagen
            'price',
            'category_id',
            'offer_id',
        ];

        /**
        * Get the attributes that should be cast.
        */
        protected function casts(): array
        {
            return [
                'price' => 'decimal:2',
            ];
        }

        /**
        * Calculate the final price after applying offer discount.
        * 
        * @return Attribute
        */
        protected function finalPrice(): Attribute
        {
            return Attribute::make(
                get: function () {
                    if ($this->offer && $this->offer->discount_percentage > 0) {
                        $discount = $this->price * ($this->offer->discount_percentage / 100);
                        return round($this->price - $discount, 2);
                    }
                    return $this->price;
                },
            );
        }

        /**
        * Get the category that owns the product.
        */
        public function category(): BelongsTo
        {
            return $this->belongsTo(Category::class);
        }

        /**
        * Get the offer that applies to this product.
        */
        public function offer(): BelongsTo
        {
            return $this->belongsTo(Offer::class);
        }

        /**
        * The users that have this product in their wishlist.
        */
        public function users(): BelongsToMany
        {
            return $this->belongsToMany(User::class)
                ->withPivot('quantity')
                ->withTimestamps();
        }
    }
    ```

### 4. Implementar sistema de notificaciones (Flash Messages)

Antes de empezar a implementar el CRUD de productos, vamos a preparar el sistema de notificaciones. Esto nos permitirá mostrar mensajes que se muestran una sola vez y luego desaparecen después de cada operación (crear, editar, eliminar) desde el primer momento.

Para ello vamos a crear un archivo parcial (partial) para las notificaciones y lo incluiremos tanto en el layout de administración (`app.blade.php`) como en el layout público (`public.blade.php`). Esto evita duplicar código y mantiene la consistencia.

#### Paso 1: Crear el partial de notificaciones

???+questionlaravel "Crea el archivo para las notificaciones flash"
    ```bash
    touch resources/views/partials/flash-messages.blade.php
    ```

???+questionlaravel "Añadir código en lash-messages.blade.php`"
    Añade el siguiente contenido al archivo `resources/views/partials/flash-messages.blade.php`:

    ```html
    <!-- Sistema de Notificaciones Flash -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        @if (session('success'))
            <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md shadow-sm" role="alert">
                <p class="font-bold">✓ Éxito</p>
                <p>{{ session('success') }}</p>
            </div>
        @endif
        
        @if (session('error'))
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-sm" role="alert">
                <p class="font-bold">✗ Error</p>
                <p>{{ session('error') }}</p>
            </div>
        @endif
        
        @if (session('info'))
            <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md shadow-sm" role="alert">
                <p class="font-bold">ⓘ Información</p>
                <p>{{ session('info') }}</p>
            </div>
        @endif
    </div>
    ```

#### Paso 2: Actualizar el layout de Administración

???+questionlaravel "Sustituye código en `app.blade.php`"
    Abre el layout principal de administración `resources/views/layouts/app.blade.php` y sustituye todo su contenido por el siguiente código:

    ```html
    <!DOCTYPE html>
    <html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <meta name="csrf-token" content="{{ csrf_token() }}">

            <title>{{ config('app.name', 'Laravel') }}</title>

            <!-- Fonts -->
            <link rel="preconnect" href="https://fonts.bunny.net">
            <link href="https://fonts.bunny.net/css?family=figtree:400,500,600&display=swap" rel="stylesheet" />

            <!-- Scripts -->
            @include('partials.head')
            @vite(['resources/css/app.css', 'resources/js/app.js'])
        </head>
        <body class="font-sans antialiased">
            <div class="min-h-screen bg-gray-100">
                @include('layouts.navigation')

                <!-- Page Heading -->
                @isset($header)
                    <header class="bg-white shadow">
                        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                            {{ $header }}
                        </div>
                    </header>
                @endisset

                <!-- Notificaciones Flash -->
                @include('partials.flash-messages')

                <!-- Page Content -->
                <main>
                    {{ $slot }}
                </main>
            </div>
        </body>
    </html>
    ```

#### Paso 3: Actualizar el layout público
Ahora vamos a incluir el mismo partial de notificaciones en el layout público para que los mensajes del carrito y wishlist también se muestren correctamente.

???+questionlaravel "Añader código en `public.blade.php`"
    Abre `resources/views/layouts/public.blade.php` y añade el include de notificaciones **después del header** y **antes del contenido**:

    Código Blade (`layouts/public.blade.php` - Fragmento)
    ```html
    <!DOCTYPE html>
    <html lang="es">
    <head>
        @include('partials.head')
    </head>
    <body class="bg-gray-50">
        <!-- Header usando partial -->
        @include('partials.header')

        <!-- Notificaciones Flash -->
        @include('partials.flash-messages')
        
        <!-- Contenido principal -->
        <main class="min-h-screen">
            @yield('content')
        </main>
        
        <!-- Footer usando partial -->
        @include('partials.footer')

        @stack('scripts')
    </body>
    </html>
    ```

Hemos implementado el sistema de notificaciones flash que permite mostrar mensajes temporales después de operaciones CRUD. Los mensajes se envían desde controladores con `->with('success', 'mensaje')` y se muestran automáticamente en ambos layouts.

## FASE 7: Implementar Creación de Productos (CREATE)

Ahora que tenemos el sistema de almacenamiento y notificaciones configurado, vamos a implementar la funcionalidad completa para crear productos, incluyendo formularios con Blade Components, validación de datos y gestión de imágenes.

### 1. Los Métodos `create()` en los Controladores

Los metodos `create()` en los controladores deben cargar las vistas de creación y pasar los datos necesarios para los formularios.

???+questionlaravel "Sustituye código en `ProductController.php`"
    Abre el archivo `app/Http/Controllers/ProductController.php` y busca el método `create()`. Reemplázalo con:

    ```php
        /**
        * Muestra el formulario para crear un nuevo producto.
        */
        public function create(): View
        {
            // Cargar todas las categorías y ofertas para los selectores del formulario
            $categories = Category::all();
            $offers = Offer::all();
            
            return view('admin.products.create', compact('categories', 'offers'));
        }
    ```

**Cargar Categorías y Ofertas**

Cargamos todas las categorías y ofertas para que el formulario de creación de productos tenga selectores desplegables.

### 3. Crear formularios

Ahora que comprendemos la sintaxis de componentes de Blade, vamos a crear los formularios para gestionar productos.

???+questionlaravel "Ejecuta"
    Para ello crearemos el directorio `resources/views/admin/products` y dentro de él crearemos el archivo `create.blade.php`.
    ```bash
    mkdir -p resources/views/admin/products
    ```

**¿Por qué separar las vistas en `admin/`?**

Organizamos las vistas de administración en una carpeta separada `resources/views/admin/` por varias razones:

**1. Organización por contexto**: Agrupa todas las funcionalidades administrativas en un solo lugar, facilitando el mantenimiento.

**2. Separación clara de responsabilidades**: Las vistas públicas (`products/`) son para visitantes, mientras que `admin/` es para gestión.

**3. Layouts diferentes**: Las vistas admin usan `layouts.app` (dashboard, menú de usuario con enlaces admin), mientras que las públicas usan `layouts.public` (navegación de tienda, footer).

**4. Escalabilidad**: Cuando añadas más funcionalidades admin (categorias, ofertas, usuarios), todo estará organizado en `admin/`.

**5. Convención de Laravel**: Es la estructura estándar usada por Laravel Breeze, Jetstream, Nova y la mayoría de proyectos profesionales.

Esta organización hace que `view('admin.products.index')` sea claramente diferente de `view('products.index')`.

Antes de crear nuestros formularios, es importante entender que Laravel Breeze utiliza **componentes de Blade** en lugar de la sintaxis tradicional con `@extends` y `@section`. Esta es la forma moderna y recomendada de trabajar con layouts en Laravel desde la versión 7.

En la parte de administración de la práctica usaremos componentes de Blade para las vistas de administración (con Breeze) y la sintaxis tradicional para las vistas públicas.

#### Formulario para Productos

???+questionlaravel "Ejecuta"
    Crea el archivo `resources/views/admin/products/create.blade.php`:
    ```bash
    touch resources/views/admin/products/create.blade.php
    ```

???+questionlaravel "Añadir código en `create.blade.php`"

    ```blade
    <x-app-layout>
        <x-slot name="header">
            <h2 class="font-semibold text-xl text-gray-800 leading-tight">
                {{ __('Crear Nuevo Producto') }}
            </h2>
        </x-slot>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                    <div class="p-6 bg-white border-b border-gray-200">
                        <form action="{{ route('admin.products.store') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
                            @csrf
                            
                            <!-- Nombre del Producto -->
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700">Nombre del Producto *</label>
                                <input type="text" id="name" name="name" value="{{ old('name') }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('name') border-red-500 @enderror" required>
                                @error('name')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Descripción -->
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Descripción *</label>
                                <textarea id="description" name="description" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('description') border-red-500 @enderror" required>{{ old('description') }}</textarea>
                                @error('description')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Imagen del Producto -->
                            <div>
                                <label for="image" class="block text-sm font-medium text-gray-700">Imagen del Producto</label>
                                <input type="file" id="image" name="image" accept="image/jpeg,image/png,image/jpg,image/webp" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 @error('image') border-red-500 @enderror">
                                <p class="mt-1 text-xs text-gray-500">Formatos permitidos: JPG, PNG, WEBP. Tamaño máximo: 2MB</p>
                                @error('image')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Precio -->
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700">Precio (€) *</label>
                                <input type="number" id="price" name="price" value="{{ old('price') }}" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('price') border-red-500 @enderror" required>
                                @error('price')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Categoría -->
                            <div>
                                <label for="category_id" class="block text-sm font-medium text-gray-700">Categoría *</label>
                                <select id="category_id" name="category_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('category_id') border-red-500 @enderror" required>
                                    <option value="">Selecciona una categoría</option>
                                    @foreach($categories as $category)
                                        <option value="{{ $category->id }}" {{ old('category_id') == $category->id ? 'selected' : '' }}>
                                            {{ $category->name }}
                                        </option>
                                    @endforeach
                                </select>
                                @error('category_id')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Oferta (Opcional) -->
                            <div>
                                <label for="offer_id" class="block text-sm font-medium text-gray-700">Oferta (Opcional)</label>
                                <select id="offer_id" name="offer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('offer_id') border-red-500 @enderror">
                                    <option value="">Sin oferta</option>
                                    @foreach($offers as $offer)
                                        <option value="{{ $offer->id }}" {{ old('offer_id') == $offer->id ? 'selected' : '' }}>
                                            {{ $offer->name }} (-{{ $offer->discount_percentage }}%)
                                        </option>
                                    @endforeach
                                </select>
                                @error('offer_id')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Botones de Acción -->
                            <div class="flex justify-end space-x-4 pt-4">
                                <a href="{{ route('admin.products.index') }}" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">
                                    Cancelar
                                </a>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                    Crear Producto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </x-app-layout>
    ```

> ⚠️ El Atributo `enctype` es **obligatorio**
> 
> Observa que la etiqueta **`<form>`** incluye **`enctype="multipart/form-data"`**. **Sin este atributo, el archivo NO se enviará al servidor**. Es el error más común al trabajar con upload de archivos.


**Validación en el cliente**

El atributo `accept="image/jpeg,image/png,image/jpg,image/webp"` limita los tipos de archivo en el selector de archivos del navegador, mejorando la experiencia del usuario. Sin embargo, **siempre debemos validar también en el servidor**.

### 3. Implementar la validación y almacenamiento

Ahora viene la parte más importante: validar y almacenar de forma segura.

#### Almacenar Productos

Modificaremos el método `store()` en `app/Http/Controllers/ProductController.php` para validar y almacenar los datos que provienen del formulario.

???+questionlaravel "Importar la clase `RedirectResponse`"
    En primer lugar importamos la clase `RedirectResponse` para poder usarlos en el método. Lo añadimos antes de la declaración de la clase.
    ```php
        <?php

        namespace App\Http\Controllers;

        // ... Otras importaciones ...
        use Illuminate\Http\RedirectResponse;
    ```

???+questionlaravel "Actualizar método `store()` de `ProductController`"
    Luego actualizamos el método `store()` para validar y almacenar los datos que provienen del formulario.

    ```php
        /**
         * Almacena un nuevo producto en la base de datos.
         */
        public function store(Request $request): RedirectResponse
        {
            // PASO 1: Validar todos los datos del formulario, incluyendo la imagen
            $validated = $request->validate([
                'name' => 'required|string|max:255|unique:products,name',
                'description' => 'required|string|max:1000',
                'image' => 'nullable|image|mimes:jpeg,png,jpg,webp|max:2048',
                'price' => 'required|numeric|min:0|max:999999.99',
                'category_id' => 'required|exists:categories,id',
                'offer_id' => 'nullable|exists:offers,id',
            ], [
                'name.required' => 'El nombre del producto es obligatorio.',
                'name.unique' => 'Ya existe un producto con ese nombre.',
                'description.required' => 'La descripción es obligatoria.',
                'image.image' => 'El archivo debe ser una imagen.',
                'image.mimes' => 'La imagen debe ser de tipo: jpeg, png, jpg, webp.',
                'image.max' => 'La imagen no debe superar los 2MB.',
                'price.required' => 'El precio es obligatorio.',
                'price.numeric' => 'El precio debe ser un número.',
                'category_id.required' => 'Debes seleccionar una categoría.',
                'category_id.exists' => 'La categoría seleccionada no es válida.',
                'offer_id.exists' => 'La oferta seleccionada no es válida.',
            ]);

            // PASO 2: Procesar la imagen si fue subida
            if ($request->hasFile('image')) {
                // Guardar en el disco 'public' dentro de la carpeta 'products'
                // Laravel genera automáticamente un nombre único para evitar colisiones
                $imagePath = $request->file('image')->store('products', 'public');
                $validated['image'] = $imagePath;
            }

            // PASO 3: Crear el producto con los datos validados
            Product::create($validated);

            // PASO 4: Redirigir con mensaje de éxito
            return redirect()
                ->route('admin.products.index')
                ->with('success', '¡Producto creado exitosamente!');
        }
    ```

Reglas de Validación usadas:

* **`required`**: campo obligatorio.
* **`string`**: debe ser una cadena de texto.
* **`max:255`**: longitud máxima de 255 caracteres.
* **`unique:products,name`**: el nombre debe ser único en la tabla `products`.
* **`exists:categories,id`**: la categoría debe existir en la tabla `categories`.
* **`exists:offers,id`**: la oferta debe existir en la tabla `offers`.
* **`numeric`**: debe ser un número (puede tener decimales).
* **`min:0`**: valor mínimo permitido.
* **`max:999999.99`**: valor máximo permitido (hasta 6 dígitos enteros y 2 decimales).
* **`nullable`**: el campo puede estar vacío (opcional).
* **`image`**: vrifica que el archivo sea una imagen válida.
* **`mimes:jpeg,png,jpg,webp`**: limita los formatos permitidos.
* **`max:2048`**: tamaño máximo de 2MB (2048 KB).



**¿Por qué `store('products', 'public')`?**

* **Primer parámetro (`'products'`)**: carpeta donde se guardará la imagen dentro del disco.
* **Segundo parámetro (`'public'`)**: disco a utilizar (público).
* Resultado: la imagen se guardará en `storage/app/public/products/nombre-generado.jpg`.

### 3. Añadir las imágenes en las vistas publicas

Ahora que los productos pueden tener imágenes cargadas por el usuario, vamos a mostrarlas en la tienda pública.

#### Actualizar el Componente `product-card` para Mostrar Imágenes

Como tenemos el componente `product-card.blade.php`, lo modificaremos para mostrar imágenes reales en lugar del emoji placeholder. Además, lo haremos más flexible usando **slots** para que pueda reutilizarse en diferentes contextos (listados públicos, wishlist, etc.).

???+questionlaravel "Reemplazar código en `product-card.blade.php`"

    Abre `resources/views/components/product-card.blade.php` y **reemplaza todo el contenido** por el siguiente:

    ```html
    <div class="bg-white rounded-lg shadow-lg overflow-hidden product-card {{ $class }} relative {{ $product->offer ? 'ring-2 ring-orange-400' : '' }}">
        <!-- Badge de oferta destacado (esquina superior derecha) -->
        @if($product->offer)
            <div class="absolute top-0 right-0 bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-bl-lg font-bold shadow-lg z-10">
                <span class="text-lg">
                    -{{ $product->offer->discount_percentage }}%
                </span>
            </div>
        @endif

        <!-- Slot opcional para botón adicional en esquina superior izquierda (ej: eliminar de wishlist) -->
        @isset($topAction)
            <div class="absolute top-2 left-2 z-10">
                {{ $topAction }}
            </div>
        @endisset

        <div class="h-48 bg-gray-200 flex items-center justify-center overflow-hidden {{ $product->offer ? 'bg-gradient-to-br from-orange-50 to-red-50' : '' }}">
            @if(!empty($product->image))
                <img src="{{ asset('storage/' . $product->image) }}" 
                    alt="{{ $product->name }}" 
                    class="w-full h-full object-cover">
            @else
                <span class="text-4xl">📦</span>
            @endif
        </div>

        <div class="p-6">
            <h4 class="text-xl font-bold mb-2 text-gray-900">{{ $product->name }}</h4>
            <p class="text-gray-600 mb-4">{{ Str::limit($product->description, 80) }}</p>

            <!-- Badge de oferta adicional (nombre de la oferta) -->
            @if($product->offer)
                <div class="mb-4">
                    <span class="inline-block bg-orange-100 text-orange-800 text-xs px-3 py-1 rounded-full font-semibold">
                        🏷️ {{ $product->offer->name }}
                    </span>
                </div>
            @endif

            <!-- Precio -->
            <div class="mb-4">
                @if($product->offer)
                    <div class="flex items-baseline gap-2">
                        <span class="text-sm text-gray-400 line-through">€{{ number_format($product->price, 2) }}</span>
                        <span class="text-2xl font-bold text-orange-600">€{{ number_format($product->final_price, 2) }}</span>
                    </div>
                @else
                    <span class="text-2xl font-bold text-primary-600">€{{ number_format($product->final_price, 2) }}</span>
                @endif
            </div>

            <!-- Acciones personalizables mediante slot -->
            @isset($actions)
                {{ $actions }}
            @else
                <!-- Acción por defecto: Ver Detalles -->
                <a href="{{ route('products.show', $product->id) }}" 
                class="block text-center bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition">
                    Ver Detalles
                </a>
            @endisset
        </div>
    </div>
    ```

#### Componente Reutilizable con Slots

Hemos añadido dos **slots opcionales** al componente para hacerlo más flexible:

* **`topAction`**: Permite añadir un botón en la esquina superior izquierda (ej: botón de eliminar de wishlist)
* **`actions`**: Permite personalizar los botones del footer de la tarjeta

Si no se proporcionan estos slots, el componente muestra su comportamiento por defecto (solo botón "Ver Detalles").

Ahora, el componente de tarjeta de producto muestra la imagen si está disponible. De lo contrario, muestra un icono genérico.

## FASE 8: Crear el Panel de administración

Ahora que ya podemos crear productos (y verlos en la tienda pública), vamos a crear el panel de administración donde los gestionaremos de forma centralizada. Esta vista mostrará tablas con todos los productos junto con botones para editarlos y eliminarlos.

### 1. Crear métodos `adminIndex` en los controladores

Necesitamos un método en cada controlador para obtener los datos y cargar la vista de administración correspondiente.

???+questionlaravel "Añadir este método a `ProductController.php`:"

    ```php
        /**
         * Muestra la lista de productos en el panel de administración.
         */
    public function adminIndex(): View
    {
        $products = Product::with(['category', 'offer'])->latest()->get();
        return view('admin.products.index', compact('products'));
    }
    ```

### 2. Crear la vista de Administración

???+questionlaravel "Crear la vista de administración"

    Ahora crearemos el archivo de la vista de administración para el panel de admin.
    ```bash
    touch resources/views/admin/products/index.blade.php
    ```

???+questionlaravel "Añadir código a `resources/views/admin/products/index.blade.php`:"

    Código Blade (`admin.products.index`)
    ```php
    <x-app-layout>
        <x-slot name="header">
            <div class="flex justify-between items-center">
            <h2 class="font-semibold text-xl text-gray-800 leading-tight">
                {{ __('Gestión de Productos') }}
            </h2>
                <a href="{{ route('admin.products.create') }}" class="inline-flex items-center px-4 py-2 border rounded-md font-semibold text-xs uppercase hover:bg-gray-100 transition">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Crear Nuevo Producto
                </a>
            </div>
        </x-slot>

        <div class="py-12">
            <div class="w-full px-4 sm:px-6 lg:px-8">
                <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Imagen</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                @forelse($products as $product)
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            @if($product->image)
                                                <img src="{{ asset('storage/' . $product->image) }}" 
                                                    alt="{{ $product->name }}" 
                                                    class="h-16 w-16 object-cover rounded-md shadow-sm">
                                            @else
                                                <div class="h-16 w-16 bg-gray-100 flex items-center justify-center rounded-md text-4xl">
                                                    📦
                                                </div>
                                            @endif
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900">{{ $product->name }}</div>
                                            <div class="text-sm text-gray-500">{{ Str::limit($product->description, 50) }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                {{ $product->category->name ?? 'N/A' }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">€{{ number_format($product->price, 2) }}</div>
                                            @if($product->offer)
                                                <div class="text-xs text-orange-600">
                                                    -{{ $product->offer->discount_percentage }}% descuento
                                                </div>
                                            @endif
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <a href="{{ route('admin.products.edit', $product) }}" 
                                            class="text-indigo-600 hover:text-indigo-900 mr-4">
                                                Editar
                                            </a>
                                            <form action="{{ route('admin.products.destroy', $product) }}" 
                                                method="POST" 
                                                class="inline-block" 
                                                onsubmit="return confirm('¿Estás seguro de que deseas eliminar este producto?');">
                                                @csrf
                                                @method('DELETE')
                                                <button type="submit" class="text-red-600 hover:text-red-900">
                                                    Eliminar
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                @empty
                                    <tr>
                                        <td colspan="5" class="px-6 py-12 text-center">
                                            <div class="text-gray-400 text-4xl mb-4">📦</div>
                                            <p class="text-gray-500 text-lg font-medium">No hay productos para mostrar</p>
                                            <p class="text-gray-400 text-sm mt-2">Crea tu primer producto usando el botón de arriba</p>
                                        </td>
                                    </tr>
                                @endforelse
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </x-app-layout>
    ```

### 3. Añadir enlaces de Administración al menú de navegación

Ahora que tenemos la vista del panel de administración, necesitamos una forma de navegar a ella. Laravel Breeze ya nos proporciona un menú de navegación en `layouts/navigation.blade.php`. Vamos a aprovecharlo añadiendo enlaces de administración.

???+questionlaravel "Modificar archivo `navigation.blade.php`"

    Abre el archivo `resources/views/layouts/navigation.blade.php` y substituye el contenido por el siguiente:

    Código Blade (`layouts/navigation.blade.php` - Fragmento)
    ```html
    <nav x-data="{ open: false }" class="bg-white border-b border-gray-100">
        <!-- Primary Navigation Menu -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <!-- Logo -->
                    <div class="shrink-0 flex items-center">
                        <a href="{{ route('dashboard') }}">
                            <x-application-logo class="block h-9 w-auto fill-current text-gray-800" />
                        </a>
                    </div>

                    <!-- Navigation Links -->
                    <div class="hidden space-x-8 sm:-my-px sm:ms-10 sm:flex">
        <x-nav-link :href="route('dashboard')" :active="request()->routeIs('dashboard')">
            {{ __('Dashboard') }}
        </x-nav-link>
        </div>
        <!-- Enlaces de Administración -->
        <x-nav-link :href="route('admin.products.index')" :active="request()->routeIs('admin.products.*')">
            {{ __('Productos') }}
        </x-nav-link>
                </div>

                <!-- Settings Dropdown -->
                <div class="hidden sm:flex sm:items-center sm:ms-6">
                    <x-dropdown align="right" width="48">
                        <x-slot name="trigger">
                            <button class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-gray-500 bg-white hover:text-gray-700 focus:outline-none transition ease-in-out duration-150">
                                <div>{{ Auth::user()->name }}</div>

                                <div class="ms-1">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </button>
                        </x-slot>

                        <x-slot name="content">
                            <x-dropdown-link :href="route('profile.edit')">
                                {{ __('Profile') }}
                            </x-dropdown-link>

                            <!-- Authentication -->
                            <form method="POST" action="{{ route('logout') }}">
                                @csrf

                                <x-dropdown-link :href="route('logout')"
                                        onclick="event.preventDefault();
                                                    this.closest('form').submit();">
                                    {{ __('Log Out') }}
                                </x-dropdown-link>
                            </form>
                        </x-slot>
                    </x-dropdown>
                </div>

                <!-- Hamburger -->
                <div class="-me-2 flex items-center sm:hidden">
                    <button @click="open = ! open" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:bg-gray-100 focus:text-gray-500 transition duration-150 ease-in-out">
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path :class="{'hidden': open, 'inline-flex': ! open }" class="inline-flex" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            <path :class="{'hidden': ! open, 'inline-flex': open }" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Responsive Navigation Menu -->
        <div :class="{'block': open, 'hidden': ! open}" class="hidden sm:hidden">
            <div class="pt-2 pb-3 space-y-1">
                <x-responsive-nav-link :href="route('dashboard')" :active="request()->routeIs('dashboard')">
                    {{ __('Dashboard') }}
                </x-responsive-nav-link>
                <!-- Enlaces de Administración -->
                <x-responsive-nav-link :href="route('admin.products.index')" :active="request()->routeIs('admin.products.*')">
                    {{ __('Productos') }}
                </x-responsive-nav-link>
                    </div>

            <!-- Responsive Settings Options -->
            <div class="pt-4 pb-1 border-t border-gray-200">
                <div class="px-4">
                    <div class="font-medium text-base text-gray-800">{{ Auth::user()->name }}</div>
                    <div class="font-medium text-sm text-gray-500">{{ Auth::user()->email }}</div>
                    </div>

                <div class="mt-3 space-y-1">
                    <x-responsive-nav-link :href="route('profile.edit')">
                        {{ __('Profile') }}
                    </x-responsive-nav-link>

                    <!-- Authentication -->
                    <form method="POST" action="{{ route('logout') }}">
                        @csrf

                        <x-responsive-nav-link :href="route('logout')"
                                onclick="event.preventDefault();
                                            this.closest('form').submit();">
                            {{ __('Log Out') }}
                        </x-responsive-nav-link>
                    </form>
                </div>
            </div>
        </div>
    </nav>
    ```

Con esta modificación, el menú de navegación superior ahora incluye el enlace a la gestión de productos, visible solo para usuarios autenticados.

???praclaravel "Captura de pantalla requerida"

    Realiza una captura de pantalla del **panel de administración** mostrando:

    1. La página `/admin/products` con la tabla de productos
    2. El **menú de navegación superior** con el enlace "Productos" visible y activo
    3. El nombre del usuario autenticado visible en la esquina superior derecha

## FASE 9: Implementar actualización y eliminación de productos

En esta fase, completaremos el ciclo CRUD implementando la funcionalidad para editar y actualizar productos. Esto implica crear los formularios de edición, implementar la lógica en los métodos `edit()` y `update()` del controlador, y manejar correctamente la actualización de imágenes.

### 1. Implementar el método `edit()`
El propósito del método `edit()` es muy simple: obtener el registro específico que se quiere editar y mostrar un formulario pre-rellenado con sus datos actuales.

???+questionlaravel "Añadir el método `edit()` a `ProductController.php`:"

    Abre el archivo `app/Http/Controllers/ProductController.php` y busca el método `edit()`. Reemplázalo con:

    ```php
        /**
         * Muestra el formulario para editar un producto existente.
         */
        public function edit(Product $product): View
        {
            // Cargar todas las categorías y ofertas para los selectores del formulario
            $categories = Category::all();
            $offers = Offer::all();
            
            return view('admin.products.edit', compact('product', 'categories', 'offers'));
        }
    ```

**Route Model Binding**

Observa que hemos cambiado `public function edit(string $id)` por `public function edit(Product $product)`. Esto es **Route Model Binding**. Laravel automáticamente buscará en la base de datos un producto con el ID de la URL y lo inyectará en el método. Si no lo encuentra, lanzará un error 404. Es más limpio y seguro.

### 2. Crear el formulario de edición

El formulario de edición es casi idéntico al de creación, pero con tres diferencias clave:

1. La acción del formulario apuntará a la ruta `update` y pasará el ID del objeto: `route('admin.products.update', $product)`.
2. Usaremos la directiva `@method('PUT')` para indicarle a Laravel que la petición, aunque se envíe como POST, debe tratarse como un PUT/PATCH.
3. Los campos del formulario estarán pre-rellenados con los datos actuales del objeto. Por ejemplo:

   ```php
   value="{{ old('name', $product->name) }}"
   ```

???+questionlaravel "Crea el archivo `resources/views/admin/products/edit.blade.php`:"
    ```bash
    touch resources/views/admin/products/edit.blade.php
    ```

???+questionlaravel "Añade el siguiente código:"

    ```php
    <x-app-layout>
        <x-slot name="header">
            <h2 class="font-semibold text-xl text-gray-800 leading-tight">
                {{ __('Editar Producto') }}
            </h2>
        </x-slot>

        <div class="py-12">
            <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
                <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                    <div class="p-6 bg-white border-b border-gray-200">
                        <form action="{{ route('admin.products.update', $product) }}" method="POST" enctype="multipart/form-data" class="space-y-6">
                            @csrf
                            @method('PUT')
                            
                            <!-- Nombre del Producto -->
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700">Nombre del Producto *</label>
                                <input type="text" id="name" name="name" value="{{ old('name', $product->name) }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('name') border-red-500 @enderror" required>
                                @error('name')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Descripción -->
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Descripción *</label>
                                <textarea id="description" name="description" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('description') border-red-500 @enderror" required>{{ old('description', $product->description) }}</textarea>
                                @error('description')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Imagen del Producto -->
                            <div>
                                <label for="image" class="block text-sm font-medium text-gray-700">Imagen del Producto</label>
                                @if ($product->image)
                                    <div class="my-2">
                                        <img src="{{ asset('storage/' . $product->image) }}" alt="Imagen actual" class="h-24 w-24 object-cover rounded-md">
                                        <p class="text-xs text-gray-500 mt-1">Imagen actual. Sube una nueva para reemplazarla.</p>
                                    </div>
                                @endif
                                <input type="file" id="image" name="image" accept="image/jpeg,image/png,image/jpg,image/webp" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 @error('image') border-red-500 @enderror">
                                <p class="mt-1 text-xs text-gray-500">Formatos permitidos: JPG, PNG, WEBP. Tamaño máximo: 2MB</p>
                                @error('image')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Precio -->
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700">Precio (€) *</label>
                                <input type="number" id="price" name="price" value="{{ old('price', $product->price) }}" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('price') border-red-500 @enderror" required>
                                @error('price')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Categoría -->
                            <div>
                                <label for="category_id" class="block text-sm font-medium text-gray-700">Categoría *</label>
                                <select id="category_id" name="category_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('category_id') border-red-500 @enderror" required>
                                    <option value="">Selecciona una categoría</option>
                                    @foreach($categories as $category)
                                        <option value="{{ $category->id }}" {{ old('category_id', $product->category_id) == $category->id ? 'selected' : '' }}>
                                            {{ $category->name }}
                                        </option>
                                    @endforeach
                                </select>
                                @error('category_id')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Oferta (Opcional) -->
                            <div>
                                <label for="offer_id" class="block text-sm font-medium text-gray-700">Oferta (Opcional)</label>
                                <select id="offer_id" name="offer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @error('offer_id') border-red-500 @enderror">
                                    <option value="">Sin oferta</option>
                                    @foreach($offers as $offer)
                                        <option value="{{ $offer->id }}" {{ old('offer_id', $product->offer_id) == $offer->id ? 'selected' : '' }}>
                                            {{ $offer->name }} (-{{ $offer->discount_percentage }}%)
                                        </option>
                                    @endforeach
                                </select>
                                @error('offer_id')
                                    <p class="mt-1 text-sm text-red-600">{{ $message }}</p>
                                @enderror
                            </div>

                            <!-- Botones de Acción -->
                            <div class="flex justify-end space-x-4 pt-4">
                                <a href="{{ route('admin.products.index') }}" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">
                                    Cancelar
                                </a>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                    Actualizar Producto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </x-app-layout>
    ```

### 3. Implementar la lógica de actualización y eliminación

Ahora implementaremos la lógica en los métodos `update()` y `destroy()` de los controladores, que se encargarán de validar los datos, manejar las imágenes y actualizar o eliminar los registros en la base de datos.

#### Paso 1: Añadir los imports necesarios

Antes de implementar los métodos de actualización y eliminación, necesitamos añadir los imports para gestionar archivos.

???+questionlaravel "Añadir linea en `ProductController.php`"
    Abre `app/Http/Controllers/ProductController.php` y busca la sección de imports. Añade la siguiente línea:
    ```php
        use Illuminate\Support\Facades\Storage;
    ```
    El facade `Storage` es necesario para eliminar archivos del disco cuando se actualiza o elimina un producto.

#### Paso 2: Actualizar el método `update()`

???+questionlaravel "Actualizar métod `update()` en `ProductController.php`:"

    ```php
        /**
         * Actualiza un producto existente en la base de datos.
         */
        public function update(Request $request, Product $product): RedirectResponse
        {
            // PASO 1: Validar los datos del formulario
            $validated = $request->validate([
                'name' => 'required|string|max:255|unique:products,name,' . $product->id,
                'description' => 'required|string|max:1000',
                'image' => 'nullable|image|mimes:jpeg,png,jpg,webp|max:2048',
                'price' => 'required|numeric|min:0|max:999999.99',
                'category_id' => 'required|exists:categories,id',
                'offer_id' => 'nullable|exists:offers,id',
            ]);

            // PASO 2: Manejar la subida de la nueva imagen
            if ($request->hasFile('image')) {
                // Eliminar la imagen anterior si existe para no acumular archivos
                if ($product->image) {
                    Storage::disk('public')->delete($product->image);
                }
                // Guardar la nueva imagen y obtener su ruta
                $imagePath = $request->file('image')->store('products', 'public');
                $validated['image'] = $imagePath;
            }

            // PASO 3: Actualizar el producto con los datos validados
            $product->update($validated);

            // PASO 4: Redirigir con mensaje de éxito
            return redirect()
                ->route('admin.products.index')
                ->with('success', '¡Producto actualizado exitosamente!');
        }
    ```

**Regla `unique` en actualización**

Al validar, la regla `unique` debe modificarse para ignorar el registro actual.

* **Antes (store):** `unique:products,name`
* **Ahora (update):** `unique:products,name,' . $product->id`

Esto le dice a Laravel: *"El nombre debe ser único, excepto para el producto con este ID"*. Si no lo hiciéramos, daría un error de validación al intentar guardar sin cambiar el nombre.

#### Paso 3: Actualizar el método `destroy()`

???+questionlaravel "Actualizar el método `destroy()` en `ProductController.php`:"

    ```php
        /**
         * Elimina un producto de la base de datos.
         */
        public function destroy(Product $product): RedirectResponse
        {
            // PASO 1: Eliminar la imagen asociada si existe
            if ($product->image) {
                Storage::disk('public')->delete($product->image);
            }

            // PASO 2: Eliminar el producto de la base de datos
            $product->delete();

            // PASO 3: Redirigir con mensaje de éxito
            return redirect()
                ->route('admin.products.index')
                ->with('success', 'Producto eliminado exitosamente.');
        }
    ```

**Limpieza de archivos**

Es una **buena práctica** eliminar siempre los archivos asociados a un registro (imágenes, PDFs, etc.) antes de eliminar el propio registro de la base de datos. Esto evita que queden "archivos huérfanos" ocupando espacio innecesario en el servidor.

Con esto, la funcionalidad de edición, actualización y eliminación está completa, incluyendo el manejo seguro y eficiente de los archivos de imagen.

???praclaravel "Capturas de pantalla requeridas - Flujos CRUD Completos"

    Realiza las capturas necesarias mostrando los tres flujos principales del CRUD:

    1. El formulario de "Crear Nuevo Producto" relleno.
    2. La tabla de administración con el **nuevo producto ya creado** y la **notificación de éxito** visible.
    3. El formulario de "Editar Producto" con los datos de un producto existente y un campo modificado.
    4. La tabla de administración con el **producto actualizado** y la **notificación de éxito** visible.
    5. El cuadro de diálogo de confirmación `confirm('¿Estás seguro...?')` al hacer clic en "Eliminar".
    6. La tabla de administración sin el producto eliminado y con la **notificación de éxito** visible.

## FASE 10: Implementar el carrito de compras con Sesiones

Tu `CartController` actual está simulando la funcionalidad y depende de un usuario fijo en la base de datos (`User::find(1)`) y de la tabla pivote `product_user`. Para que la tienda sea funcional para cualquier visitante, vamos a refactorizarlo completamente para que utilice el **sistema de sesiones de Laravel**. Esto permitirá que tanto usuarios invitados como autenticados puedan gestionar su propio carrito.

### 1. ¿Cómo funcionará?

* **Almacenamiento en Sesión:** El carrito ya no se guardará en la tabla `product_user`. En su lugar, será un array almacenado en la sesión del navegador del usuario. Si la sesión expira, el carrito se vaciará.
* **Lógica Real:** Implementaremos la lógica completa para añadir, actualizar, eliminar y vaciar el carrito.
* **Finalizar Compra:** Añadiremos un botón para "Realizar el Pedido", que simulará la compra vaciando el carrito y mostrando un mensaje de confirmación.

**¿Qué pasa con la tabla `product\_user`?**

La tabla `product_user` que creamos en P3 **ya no se usará para el carrito** (que ahora usa sesiones más apropiadas para datos temporales), pero la **mantendremos activa** porque en FASE 11 la reutilizaremos para implementar la **Lista de Deseos (wishlist)**.

Esta separación refleja el comportamiento habitual de tiendas online reales: el carrito es volátil y público, mientras que los favoritos son persistentes y privados.

### 2. Refactorizar el `CartController` para usar sesiones

Este es el paso central. Vamos a reescribir por completo tu `CartController` para que toda la lógica del carrito se gestione a través del helper `session()`.

???+questionlaravel "Reemplazar el contenido de `app/Http/Controllers/CartController.php`:"

    ```php
    <?php

    namespace App\Http\Controllers;

    use App\Models\Product;
    use Illuminate\Http\Request;
    use Illuminate\View\View;
    use Illuminate\Http\RedirectResponse;
    use Illuminate\Support\Collection;

    class CartController extends Controller
    {
        /**
         * Muestra la vista del carrito de compras con los datos de la sesión.
         */
        public function index(): View
        {
            $cart = session()->get('cart', []);

            // Obtenemos los IDs de los productos del carrito
            $productIds = array_keys($cart);

            // Cargamos los modelos de producto con sus relaciones
            $cartProducts = Product::with(['category', 'offer'])->find($productIds);

            // Añadimos la cantidad a cada producto para usarla en la vista
            $cartProducts = $cartProducts->map(function ($product) use ($cart) {
                $product->quantity = $cart[$product->id]['quantity'];
                return $product;
            });

            return view('cart.index', [
                'cartProducts' => $cartProducts
            ]);
        }

        /**
         * Añade un producto al carrito de compras en la sesión.
         */
        public function store(Request $request): RedirectResponse
        {
            $request->validate(['product_id' => 'required|exists:products,id']);
            $productId = $request->input('product_id');
            
            $cart = session()->get('cart', []);

            if (isset($cart[$productId])) {
                $cart[$productId]['quantity']++;
            } else {
                $cart[$productId] = ["quantity" => 1];
            }

            session()->put('cart', $cart);
            return redirect()->back()->with('success', '¡Producto añadido al carrito!');
        }

        /**
         * Actualiza la cantidad de un producto en el carrito.
         */
        public function update(Request $request, string $id): RedirectResponse
        {
            $request->validate(['quantity' => 'required|integer|min:1']);
            
            $cart = session()->get('cart', []);

            if (isset($cart[$id])) {
                $cart[$id]['quantity'] = $request->input('quantity');
                session()->put('cart', $cart);
                return redirect()->route('cart.index')->with('success', 'Cantidad actualizada correctamente.');
            }

            return redirect()->route('cart.index')->with('error', 'El producto no se encontró en el carrito.');
        }

        /**
         * Elimina un producto del carrito de compras.
         */
        public function destroy(string $id): RedirectResponse
        {
            $cart = session()->get('cart', []);

            if (isset($cart[$id])) {
                unset($cart[$id]); // Elimina el elemento del array
                session()->put('cart', $cart);
                return redirect()->route('cart.index')->with('success', 'Producto eliminado del carrito.');
            }

            return redirect()->route('cart.index')->with('error', 'El producto no se encontró en el carrito.');
        }
        
        /**
         * Simula la finalización de la compra, vaciando el carrito.
         */
        public function checkout(): RedirectResponse
        {
            session()->forget('cart'); // Vacía el carrito de la sesión
            return redirect()->route('welcome')->with('success', '¡Pedido realizado con éxito! Gracias por tu compra.');
        }
    }
    ```

**¿Cómo funciona el nuevo método `index()`?**

Para que tu vista actual siga funcionando, el controlador ahora:

1. Obtiene los IDs de producto desde la sesión.
2. Busca en la base de datos los **modelos Eloquent** correspondientes.
3. Añade una propiedad `quantity` a cada modelo de producto.
4. Pasa esta colección de productos enriquecidos a la vista como `$cartProducts`, exactamente como la vista espera.

### 3. Añadir las rutas avanzadas del carrito

Ahora que tenemos el `CartController` completo con todos sus métodos, debemos registrar las rutas avanzadas que faltaban.

???+questionlaravel "Reemplazar las rutas básicas del carrito por rutas completas"

    Abre `routes/web.php` y **reemplaza** las rutas básicas del carrito por las rutas completas:

    ```php
    // Rutas del carrito de compras (ahora completas)
    Route::get('/cart', [CartController::class, 'index'])->name('cart.index');
    Route::post('/cart', [CartController::class, 'store'])->name('cart.store');
    Route::put('/cart/{id}', [CartController::class, 'update'])->name('cart.update');
    Route::delete('/cart/{id}', [CartController::class, 'destroy'])->name('cart.destroy');
    Route::post('/checkout', [CartController::class, 'checkout'])->name('cart.checkout');
    ```

### 4. Actualizar las vistas para la funcionalidad del carrito

#### Botón "Añadir al carrito"

El enlace simple debe convertirse en un formulario para poder enviar la petición `POST` de forma segura.

???+questionlaravel "Reemplazar la sección "Botones de Acción" en `resources/views/products/show.blade.php`"

    ```php
    <!-- Botones de Acción -->
    <div class="flex items-center space-x-4">
        <form action="{{ route('cart.store') }}" method="POST">
            @csrf
            <input type="hidden" name="product_id" value="{{ $product->id }}">
            <button type="submit" class="bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition">
                🛒 Añadir al Carrito
            </button>
        </form>
        <a href="{{ route('products.index') }}" 
        class="border border-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-100 transition">
            ← Volver a Productos
        </a>
    </div>
    ```

#### Vista del carrito (`cart.index`)

Ahora, haremos dos pequeños cambios en la vista del carrito para que sea interactiva.

???+questionlaravel "Reemplazar modificaciones en   `resources/views/cart/index.blade.php`"

    1. Reemplaza la cantidad estática (`{{ $product->pivot->quantity }}`) por un formulario de actualización.
    2. Añade un formulario de eliminación.
    3. Convierte el botón "Proceder al Pago" en un formulario que apunte a la nueva ruta `cart.checkout`.

    ```html
    @extends('layouts.public')

    @section('content')
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">🛒 Carrito de Compras</h1>

        @if($cartProducts->isEmpty())
            <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                <div class="text-6xl mb-4">🛒</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Tu carrito está vacío</h2>
                <p class="text-gray-600 mb-6">¡Añade productos para comenzar tu compra!</p>
                <a href="{{ route('products.index') }}" class="inline-block bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition">
                    Ver Productos
                </a>
            </div>
        @else
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Producto</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Precio</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Cantidad</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Subtotal</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @php $total = 0; @endphp
                        
                        @foreach($cartProducts as $product)
                            @php
                                // Calculamos el subtotal usando el accessor final_price
                                $subtotal = $product->final_price * $product->quantity;
                                $total += $subtotal;
                            @endphp
                            
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        @if($product->image)
                                            <img src="{{ asset('storage/' . $product->image) }}" 
                                                alt="{{ $product->name }}" 
                                                class="h-16 w-16 object-cover rounded-md mr-4">
                                        @else
                                            <div class="h-16 w-16 bg-gray-100 flex items-center justify-center rounded-md text-4xl mr-4">
                                                📦
                                            </div>
                                        @endif
                                        <div>
                                            <div class="font-semibold text-gray-900">{{ $product->name }}</div>
                                            <div class="text-sm text-gray-600">{{ $product->category->name }}</div>
                                            @if($product->offer)
                                                <span class="inline-block bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full mt-1">
                                                    🏷️ -{{ $product->offer->discount_percentage }}%
                                                </span>
                                            @endif
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    @if($product->offer)
                                        <div>
                                            <span class="text-sm text-gray-400 line-through">€{{ number_format($product->price, 2) }}</span>
                                            <div class="font-semibold text-orange-600">€{{ number_format($product->final_price, 2) }}</div>
                                        </div>
                                    @else
                                        <div class="font-semibold text-gray-900">€{{ number_format($product->final_price, 2) }}</div>
                                    @endif
                                </td>
                                <td class="px-6 py-4">
                                    <!-- FORMULARIO PARA ACTUALIZAR CANTIDAD -->
                                    <form action="{{ route('cart.update', $product->id) }}" method="POST" class="flex items-center justify-center">
                                        @csrf
                                        @method('PUT')
                                        <input type="number" name="quantity" value="{{ $product->quantity }}" min="1" class="w-20 text-center border-gray-300 rounded-md shadow-sm">
                                        <button type="submit" class="ml-2 p-1 text-indigo-600 hover:text-indigo-800" title="Actualizar cantidad">🔄</button>
                                    </form>
                                </td>
                                <td class="px-6 py-4 font-semibold text-gray-900">€{{ number_format($subtotal, 2) }}</td>
                                <td class="px-6 py-4 text-center">
                                    <!-- FORMULARIO PARA ELIMINAR -->
                                    <form action="{{ route('cart.destroy', $product->id) }}" method="POST">
                                        @csrf
                                        @method('DELETE')
                                        <button type="submit" class="text-red-600 hover:text-red-800" title="Eliminar producto">🗑️ Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                    <tfoot class="bg-gray-50">
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-right font-semibold text-gray-700">Total:</td>
                            <td class="px-6 py-4 font-bold text-xl text-primary-600">€{{ number_format($total, 2) }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-6 flex justify-between items-center">
                <a href="{{ route('products.index') }}" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition">
                    ← Seguir Comprando
                </a>
                <!-- FORMULARIO PARA FINALIZAR COMPRA -->
                <form action="{{ route('cart.checkout') }}" method="POST">
                    @csrf
                    <button type="submit" class="bg-green-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-green-700 transition">
                        Realizar Pedido →
                    </button>
                </form>
            </div>
        @endif
    </div>
    @endsection
    ```

**Cambio clave en la vista**

Hemos reemplazado todas las apariciones de `$product->pivot->quantity` por `$product->quantity`. Gracias a la lógica del nuevo `CartController`, esta propiedad ahora existe directamente en el objeto `$product`.

#### Actualizar el contador del carrito en el header

Ahora vamos a darle funcionalidad al contador del carrito que aparece en el header de la tienda pública.

???+questionlaravel "Reemplazar código del contador en `header.blade.php`"
    Abre `resources/views/partials/header.blade.php` y busca la sección del carrito. Reemplaza el código del contador:

    ```html
    <!-- Carrito de Compras -->
    <header class="bg-white shadow-lg relative">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-4">
                <a href="{{ route('welcome') }}" class="text-2xl font-bold text-primary-600">
                        🛍️ Mi Tienda
                    </a>
                </div>
                
            <!-- Navegación usando partial -->
            @include('partials.navigation')
                
                <!-- Carrito -->
                @php
                    $cart = session('cart', []);
                    $totalQuantity = array_sum(array_column($cart, 'quantity'));
                @endphp
                <div class="flex items-center space-x-4">
                <a href="{{ route('cart.index') }}" 
                    class="text-gray-700 hover:text-primary-600 transition">
                        🛒 Carrito ( {{ $totalQuantity }} )
                </a>
                </div>
            </div>
        </div>
    </header>
    ```

**Contador con Sesiones**
El contador usa `array_sum(array_column($cart, 'quantity'))` para contar productos en la sesión.

???praclaravel "Captura de pantalla requerida"

    Realiza una captura de pantalla de la **página del carrito funcional**, mostrando:

    1. Al menos dos productos diferentes en el carrito.
    2. Uno de ellos ha de tener 5 unidades.
    3. Cantidades, precios, subtotales y el total calculado visible.
    4. Botones para actualizar (🔄) y eliminar (🗑️) visibles.
    5. **Contador del carrito en el header** mostrando el número correcto de productos (ej: "Carrito (6)").

## FASE 11: Añadir lista de deseos

Ahora que nuestro carrito usa sesiones en lugar de la tabla pivot `product_user`, vamos a reaprovechar esta tabla para implementar una **lista de deseos (wishlist)** exclusiva para usuarios autenticados.

### 1. ¿Cómo funciona la lista de Deseos?

* **Solo para usuarios autenticados**: Los usuarios deben iniciar sesión para guardar productos favoritos.
* **Persistente**: A diferencia del carrito (que usa sesiones), la wishlist se guarda en la base de datos.
* **Integración en el carrito**: Los productos de la wishlist se mostrarán en la vista del carrito para facilitar su compra.

**Reutilización de la tabla `product\_user`**

En un proyecto real desde cero, quizás nombraríamos esta tabla `user_wishlist` o `product_wishlist` para mayor claridad semántica. Sin embargo, **esta situación refleja un escenario muy común en el desarrollo**: los requisitos evolucionan, y a veces es más eficiente adaptar estructuras existentes que crear nuevas. Esto te enseña a ser pragmático y aprovechar lo que ya tienes.

### 2. Crear el controlador de wishlist

???+questionlaravel "Ejecuta"
    ```bash
    sail artisan make:controller WishlistController
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan make:controller WishlistController

        INFO  Controller [app/Http/Controllers/WishlistController.php] created successfully.
        ```

Ya hemos creado el archivo del controlador. Ahora vamos a añadirle la lógica para gestionar la lista de deseos del usuario actualmente autenticado.

???+questionlaravel "Reemplazar contenido de `app/Http/Controllers/WishlistController.php`:"

    ```php
    <?php

    namespace App\Http\Controllers;

    use App\Models\Product;
    use Illuminate\Http\RedirectResponse;
    use Illuminate\View\View;

    class WishlistController extends Controller
    {
        /**
         * Muestra la lista de deseos del usuario autenticado.
         */
        public function index(): View
        {
            $user = auth()->user();
            $wishlistProducts = $user->products()->with(['category', 'offer'])->get();
            
            return view('admin.wishlist.index', [
                'wishlistProducts' => $wishlistProducts
            ]);
        }

        /**
         * Añade un producto a la lista de deseos.
         */
        public function store(string $id): RedirectResponse
        {
            $user = auth()->user();
            $product = Product::findOrFail($id);
            
            // Verificar si ya está en la wishlist
            if ($user->products()->where('product_id', $id)->exists()) {
                return redirect()->back()->with('info', 'Este producto ya está en tu lista de deseos.');
            }
            
            // Añadir a la wishlist
            $user->products()->attach($id, ['quantity' => 1]);
            
            return redirect()->back()->with('success', '¡Producto añadido a tu lista de deseos!');
        }

        /**
         * Elimina un producto de la lista de deseos.
         */
        public function destroy(string $id): RedirectResponse
        {
            $user = auth()->user();
            $user->products()->detach($id);
            
            return redirect()->back()->with('success', 'Producto eliminado de tu lista de deseos.');
        }
    }
    ```

**Relación N:M en acción**

* `auth()->user()`: Obtiene el modelo del usuario actualmente autenticado.
* `$user->products()`: Accede a la relación belongsToMany definida en el modelo `User`
* `attach($id, ['quantity' => 1])`: Añade una fila en `product_user`
* `detach($id)`: Elimina la fila correspondiente.
* `exists()`: Verifica si ya existe la relación sin cargar el producto.

### 3. Añadir las Rutas de wishlist

Ahora que tenemos el controlador, necesitamos registrar las rutas para que sean accesibles.

???+questionlaravel "Añadir las rutas de wishlist"

    Abre `routes/web.php` y añade las rutas de wishlist **dentro del grupo de administración**. Busca el grupo de rutas admin y añade las rutas de wishlist:
    ```php
    Route::middleware('auth')->prefix('admin')->name('admin.')->group(function () {
        // Rutas de gestión de productos
        Route::get('/products', [ProductController::class, 'adminIndex'])->name('products.index');
        Route::resource('products', ProductController::class)->except(['index', 'show']);
        
        // Rutas para la lista de deseos (Wishlist) ← AÑADIR ESTAS LÍNEAS
        Route::get('/wishlist', [WishlistController::class, 'index'])->name('wishlist.index');
        Route::post('/wishlist/{id}', [WishlistController::class, 'store'])->name('wishlist.store');
        Route::delete('/wishlist/{id}', [WishlistController::class, 'destroy'])->name('wishlist.destroy');
    });
    ```

    **No olvides añadir el import** al inicio del archivo `routes/web.php` (junto a los otros controladores):

    ```php
    use App\Http\Controllers\WishlistController;
    ```

**Rutas RESTful de wishlist**

La wishlist tiene rutas completas para todas las operaciones necesarias:

* `GET /admin/wishlist` → Ver lista de deseos (index).
* `POST /admin/wishlist/{id}` → Añadir producto (store).
* `DELETE /admin/wishlist/{id}` → Eliminar producto (destroy).

Observa que no necesitamos `update` porque la wishlist no tiene cantidades variables (siempre es 1).

### 4. Crear la vista de wishlist

Necesitamos una página donde el usuario pueda ver todos sus productos guardados.

???+questionlaravel "Crea el directorio:"
    ```bash
    mkdir -p resources/views/admin/wishlist
    ```

???+questionlaravel "Crea el archivo:"
    ```bash
    touch resources/views/admin/wishlist/index.blade.php
    ```

???+questionlaravel "Añadir código a `resources/views/admin/wishlist/index.blade.php`:"

    ```php
    <x-app-layout>
        <x-slot name="header">
            <h2 class="font-semibold text-xl text-gray-800 leading-tight">
                {{ __('Mi Lista de Deseos') }}
            </h2>
        </x-slot>

        <div class="py-12">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                    <div class="p-6 bg-white border-b border-gray-200">
                        @if($wishlistProducts->isEmpty())
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">💔</div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Tu lista de deseos está vacía</h3>
                                <p class="text-gray-600 mb-6">Explora nuestros productos y guarda tus favoritos</p>
                                <a href="{{ route('products.index') }}" class="inline-block bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition">
                                    Explorar Productos
                                </a>
                            </div>
                        @else
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                @foreach($wishlistProducts as $product)
                                    <x-product-card :product="$product" class="">
                                        <!-- Slot para botón de eliminar en esquina superior izquierda -->
                                        <x-slot name="topAction">
                                            <form action="{{ route('admin.wishlist.destroy', $product->id) }}" method="POST">
                                                @csrf
                                                @method('DELETE')
                                                <button type="submit" class="text-2xl hover:scale-125 transition-transform" title="Eliminar de favoritos">
                                                    ❌
                                                </button>
                                            </form>
                                        </x-slot>

                                        <!-- Slot para acciones personalizadas en el footer -->
                                        <x-slot name="actions">
                                            <div class="flex gap-2">
                                                <form action="{{ route('cart.store') }}" method="POST" class="flex-1">
                                                    @csrf
                                                    <input type="hidden" name="product_id" value="{{ $product->id }}">
                                                    <button type="submit" class="w-full bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition">
                                                        🛒 Añadir al Carrito
                                                    </button>
                                                </form>
                                                <a href="{{ route('products.show', $product->id) }}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                                                    Ver
                                                </a>
                                            </div>
                                        </x-slot>
                                    </x-product-card>
                                @endforeach
                            </div>
                        @endif
                    </div>
                </div>
            </div>
        </div>
    </x-app-layout>
    ```

**Reutilización de componentes con slots**

Esta vista reutiliza el componente `<x-product-card>` que creamos en FASE 7, usando **slots** para personalizar su comportamiento:

* **Slot `topAction`**: Añade el botón "❌" para eliminar de favoritos en la esquina superior izquierda.
* **Slot `actions`**: Personaliza los botones del footer con "Añadir al Carrito" y "Ver".

Esto evita duplicar código HTML, mantiene la consistencia visual en toda la aplicación y hace el código más mantenible. El componente se adapta al contexto sin necesidad de crear versiones diferentes.

### 5. Añadir botón "Añadir a Favoritos" en vista pública

Finalmente, debemos añadir un botón en la página de detalle del producto para que los usuarios puedan añadirlo a su lista de deseos. Este botón solo debe aparecer si el usuario ha iniciado sesión.

???+questionlaravel "Actualiza `resources/views/products/show.blade.php` para añadir el botón de wishlist"
    Actualiza `resources/views/products/show.blade.php` para añadir el botón de wishlist. Busca la sección "Botones de Acción" y reemplázala por:
    ```php
    <!-- Botones de Acción -->
    <div class="flex items-center space-x-4">
        <form action="{{ route('cart.store') }}" method="POST">
            @csrf
            <input type="hidden" name="product_id" value="{{ $product->id }}">
            <button type="submit" class="bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition">
                🛒 Añadir al Carrito
            </button>
        </form>

        <!-- Botón de Wishlist (solo para usuarios autenticados) -->
        @auth
            <form action="{{ route('admin.wishlist.store', $product->id) }}" method="POST">
                @csrf
                <button type="submit" class="border-2 border-red-500 text-red-500 px-6 py-3 rounded-lg hover:bg-red-500 hover:text-white transition">
                    ❤️ Guardar en Favoritos
                </button>
            </form>
        @endauth

        <a href="{{ route('products.index') }}" 
        class="border border-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-100 transition">
            ← Volver a Productos
        </a>
    </div>
    ```

### 6. Añadir enlace de wishlist al menú de navegación

Ahora que la funcionalidad de wishlist está completa, vamos a añadir el enlace correspondiente al menú de navegación. Además, para poder volver a la tienda pública, vamos a añadir el enlace a la tienda pública.

???+questionlaravel "Sustituye contenido de `resources/views/layouts/navigation.blade.php` por:" 

    ```html
    <nav x-data="{ open: false }" class="bg-white border-b border-gray-100">
        <!-- Primary Navigation Menu -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <!-- Logo -->
                    <div class="shrink-0 flex items-center">
                        <a href="{{ route('dashboard') }}">
                            <x-application-logo class="block h-9 w-auto fill-current text-gray-800" />
                        </a>
                    </div>

                    <!-- Navigation Links -->
                    <div class="hidden space-x-8 sm:-my-px sm:ms-10 sm:flex">
                        <x-nav-link :href="route('welcome')" :active="request()->routeIs('welcome')">
                            {{ __('Tienda') }}
                        </x-nav-link>
                        <x-nav-link :href="route('dashboard')" :active="request()->routeIs('dashboard')">
                            {{ __('Dashboard') }}
                        </x-nav-link>
                        <!-- Enlaces de Administración -->
                        <x-nav-link :href="route('admin.products.index')" :active="request()->routeIs('admin.products.*')">
                            {{ __('Productos') }}
                        </x-nav-link>
                        <x-nav-link :href="route('admin.wishlist.index')" :active="request()->routeIs('admin.wishlist.*')">
                            {{ __('❤️ Lista de Deseos') }}
                        </x-nav-link>
                    </div>
                </div>

                <!-- Settings Dropdown -->
                <div class="hidden sm:flex sm:items-center sm:ms-6">
                    <x-dropdown align="right" width="48">
                        <x-slot name="trigger">
                            <button class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-gray-500 bg-white hover:text-gray-700 focus:outline-none transition ease-in-out duration-150">
                                <div>{{ Auth::user()->name }}</div>

                                <div class="ms-1">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </button>
                        </x-slot>

                        <x-slot name="content">
                            <x-dropdown-link :href="route('profile.edit')">
                                {{ __('Profile') }}
                            </x-dropdown-link>

                            <!-- Authentication -->
                            <form method="POST" action="{{ route('logout') }}">
                                @csrf

                                <x-dropdown-link :href="route('logout')"
                                        onclick="event.preventDefault();
                                                    this.closest('form').submit();">
                                    {{ __('Log Out') }}
                                </x-dropdown-link>
                            </form>
                        </x-slot>
                    </x-dropdown>
                </div>

                <!-- Hamburger -->
                <div class="-me-2 flex items-center sm:hidden">
                    <button @click="open = ! open" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:bg-gray-100 focus:text-gray-500 transition duration-150 ease-in-out">
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path :class="{'hidden': open, 'inline-flex': ! open }" class="inline-flex" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            <path :class="{'hidden': ! open, 'inline-flex': open }" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Responsive Navigation Menu -->
        <div :class="{'block': open, 'hidden': ! open}" class="hidden sm:hidden">
            <div class="pt-2 pb-3 space-y-1">
                <x-responsive-nav-link :href="route('welcome')" :active="request()->routeIs('welcome')">
                    {{ __('Tienda') }}
                </x-responsive-nav-link>
                <x-responsive-nav-link :href="route('dashboard')" :active="request()->routeIs('dashboard')">
                    {{ __('Dashboard') }}
                </x-responsive-nav-link>
                <!-- Enlaces de Administración -->
                <x-responsive-nav-link :href="route('admin.products.index')" :active="request()->routeIs('admin.products.*')">
                    {{ __('Productos') }}
                </x-responsive-nav-link>
                <x-responsive-nav-link :href="route('admin.wishlist.index')" :active="request()->routeIs('admin.wishlist.*')">
                    {{ __('❤️ Lista de Deseos') }}
                </x-responsive-nav-link>
            </div>

            <!-- Responsive Settings Options -->
            <div class="pt-4 pb-1 border-t border-gray-200">
                <div class="px-4">
                    <div class="font-medium text-base text-gray-800">{{ Auth::user()->name }}</div>
                    <div class="font-medium text-sm text-gray-500">{{ Auth::user()->email }}</div>
                </div>

                <div class="mt-3 space-y-1">
                    <x-responsive-nav-link :href="route('profile.edit')">
                        {{ __('Profile') }}
                    </x-responsive-nav-link>

                    <!-- Authentication -->
                    <form method="POST" action="{{ route('logout') }}">
                        @csrf

                        <x-responsive-nav-link :href="route('logout')"
                                onclick="event.preventDefault();
                                            this.closest('form').submit();">
                            {{ __('Log Out') }}
                        </x-responsive-nav-link>
                    </form>
                </div>
            </div>
        </div>
    </nav>
    ```

???praclaravel "Captura de pantalla requerida"

    Realiza una captura de pantalla de la página **`/admin/wishlist`** mostrando:

    1. Al menos 2 productos guardados en la lista de deseos.
    2. Información completa de los productos (imagen, nombre, precio, oferta si aplica).
    3. Botones "Añadir al Carrito" y "❌" visibles.
    4. **Menú de navegación superior** con el enlace "❤️ Lista de Deseos" visible y activo.
    5. Usuario autenticado (nombre visible en la esquina superior derecha).
    6. URL `/admin/wishlist` visible en el navegador.

## FASE 12: Middleware prsonalizado

Los middleware personalizados permiten añadir lógica adicional que se ejecuta en cada petición. Son útiles para registrar actividad, verificar permisos complejos, etc. Vamos a crear un middleware que registre la actividad de los administradores.

### 1. Crear el middleware

???+questionlaravel "Ejecuta"
    ```bash
    sail artisan make:middleware LogUserActivity
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ sail artisan make:middleware LogUserActivity

        INFO  Middleware [app/Http/Middleware/LogUserActivity.php] created successfully.
        ```

???+questionlaravel "Reemplaza contenido de `app/Http/Middleware/LogUserActivity.php` por:"

    ```php
    <?php

    namespace App\Http\Middleware;

    use Closure;
    use Illuminate\Http\Request;
    use Illuminate\Support\Facades\Log;
    use Symfony\Component\HttpFoundation\Response;

    class LogUserActivity
    {
        /**
         * Handle an incoming request.
         *
         * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
         */
        public function handle(Request $request, Closure $next): Response
        {
            // Ejecutar la petición y obtener la respuesta
            $response = $next($request);

            // Si el usuario está autenticado, registrar su actividad
            if (auth()->check()) {
                Log::info('Actividad de usuario', [
                    'user_id' => auth()->id(),
                    'user_name' => auth()->user()->name,
                    'method' => $request->method(),
                    'url' => $request->fullUrl(),
                    'ip' => $request->ip(),
                ]);
            }

            return $response;
        }
    }
    ```

### 2. Registrar el middleware con alias

Para aplicar middleware de forma selectiva, Laravel permite crear **alias**. Esto nos permite usar nombres cortos como `log.activity` en lugar de la ruta completa de la clase.

???+questionlaravel "Registrar el middleware como alias en `bootstrap/app.php`:"

    ```php
    <?php

    use Illuminate\Foundation\Application;
    use Illuminate\Foundation\Configuration\Exceptions;
    use Illuminate\Foundation\Configuration\Middleware;

    return Application::configure(basePath: dirname(__DIR__))
        ->withRouting(
            web: __DIR__.'/../routes/web.php',
            commands: __DIR__.'/../routes/console.php',
            health: '/up',
        )
        ->withMiddleware(function (Middleware $middleware) {
            // Registrar middleware con alias
            $middleware->alias([
                'log.activity' => \App\Http\Middleware\LogUserActivity::class,
            ]);
        })
        ->withExceptions(function (Exceptions $exceptions) {
            //
        })->create();
    ```

**¿Por qué usar alias?**

Los alias de middleware ofrecen varias ventajas:

* ✅ **Nombres descriptivos**: `log.activity` es más claro que la ruta completa de la clase.
* ✅ **Aplicación selectiva**: Puedes aplicarlo solo a rutas específicas.
* ✅ **Reutilizable**: Otros desarrolladores pueden usar el alias sin conocer la implementación.
* ✅ **Estándar de Laravel**: Breeze usa alias como `auth`, `guest`, `verified`, etc.

### 3. Aplicar el middleware Solo a rutas de administración

Ahora que tenemos el alias registrado, vamos a aplicar el middleware únicamente al grupo de rutas de administración.

???+questionlaravel "Añadir el middleware `log.activity` al grupo admin en `routes/web.php`"

    ```php
    // ===========================================
    // RUTAS DE ADMINISTRACIÓN (Protegidas + Logging)
    // ===========================================

    Route::middleware(['auth', 'log.activity'])->prefix('admin')->name('admin.')->group(function () {
        // Rutas de gestión de productos
        Route::get('/products', [ProductController::class, 'adminIndex'])->name('products.index');
        Route::resource('products', ProductController::class)->except(['index', 'show']);
        
        // Rutas para la lista de deseos (Wishlist)
        Route::get('/wishlist', [WishlistController::class, 'index'])->name('wishlist.index');
        Route::post('/wishlist/{id}', [WishlistController::class, 'store'])->name('wishlist.store');
        Route::delete('/wishlist/{id}', [WishlistController::class, 'destroy'])->name('wishlist.destroy');
    });
    ```

**Middleware Selectivo**

Ahora el middleware `LogUserActivity` solo registrará actividad en las rutas de administración:

Esto reduce el ruido en los logs y se enfoca en las acciones administrativas críticas.

### 4. Ver los logs

???+questionlaravel "Navegar como usuario autenticado"
    Navega por tu aplicación como usuario autenticado. Luego, revisa el archivo de logs para ver los registros de actividad.
    ```bash
    tail -f storage/logs/laravel.log
    ```

    ???examplelaravel "Ejemplo de respuesta"

        ```bash
        artur@pc_classe:~/development/laravel/MyShop$ tail -f storage/logs/laravel.log
        [2025-10-19 17:08:19] local.INFO: Actividad de usuario {"user_id":4,"user_name":"Guillermo Garrido Portes","method":"GET","url":"http://localhost/admin/products","ip":"123.45.67.89"} 
        [2025-10-19 17:08:22] local.INFO: Actividad de usuario {"user_id":4,"user_name":"Guillermo Garrido Portes","method":"GET","url":"http://localhost/admin/wishlist","ip":"123.45.67.89"}
        ```

???praclaravel "Captura de pantalla requerida"

    Realiza una captura de pantalla del **terminal** mostrando:

    1. El comando `tail -f storage/logs/laravel.log` ejecutándose.
    2. Al menos una entrada de log con "Actividad de usuario" que incluya ID, nombre, método HTTP, URL e IP.
    3. La entrada debe haberse generado después de navegar a una página de administración como usuario autenticado.

## FASE 13: Probar la aplicación completa

Realiza una verificación final de todas las funcionalidades para asegurar que la aplicación es robusta y funciona como se espera.

### 1. Lista de verificación

#### Autenticación

* [ ] Registro, Login, Logout funcionan correctamente.
* [ ] Rutas `/admin/*` son inaccesibles para usuarios no autenticados.

#### CRUD de productos (Admin)

* [ ] Crear un producto desde `/admin/products/create`.
* [ ] Editar un producto y guardar los cambios.
* [ ] Eliminar un producto desde la tabla de administración.
* [ ] La validación de formularios funciona correctamente.
* [ ] Las notificaciones de éxito aparecen después de cada operación.

#### Carrito de compras

* [ ] Añadir productos al carrito desde la vista pública.
* [ ] Actualizar cantidades y eliminar productos desde el carrito.
* [ ] Finalizar compra vacía el carrito y muestra el mensaje de éxito.

#### Lista de deseos

* [ ] Añadir productos a la lista de deseos desde la vista pública.
* [ ] Eliminar productos de la lista de deseos desde la vista de la lista de deseos.

#### Middleware de actividad

* [ ] El middleware registra la actividad de los usuarios autenticados en el log.
* [ ] Las entradas de log contienen ID de usuario, nombre, método, URL e IP.



???praclaravel "Entrega de la práctica"

    ### Requisitos de entrega

    Para completar esta práctica, debes entregar un **PDF** que incluya las siguientes **9 capturas de pantalla numeradas**:

    ---

    #### Captura 1: Preparación de layouts (FASE 2)

    * Navegador mostrando la página principal funcionando correctamente.
    * Terminal con el comando `ls -l resources/views/layouts/` mostrando la existencia de `public.blade.php`.

    ---

    #### Captura 2: Instalación de Breeze (FASE 3)

    * Navegador mostrando las páginas de **registro** (`/register`) y **login** (`/login`).
    * Terminal mostrando el resultado de `sail artisan route:list | grep -E "(login|register|logout)"`.

    ---

    #### Captura 3: Panel de administración con navegación (FASE 8)

    * Navegador mostrando el panel de **Gestión de Productos** en `/admin/products`.
    * Debe ser visible el **menú de navegación superior** con el enlace "Productos" activo.
    * Al menos un producto debe estar visible en la tabla (creado en FASE 7).
    * Usuario autenticado visible en la esquina superior derecha.

    ---

    #### Captura 4: Flujo de creación completo (FASE 7 y 8)

    * Una imagen compuesta o dos capturas mostrando:
    1. El formulario de "Crear Nuevo Producto" relleno (FASE 7).
    2. La tabla de administración con el **nuevo producto ya creado** y la **notificación de éxito** ("¡Producto creado exitosamente!") visible en la parte superior (FASE 8).

    ---

    #### Captura 5: Flujo de edición completo (FASE 9)

    * Una imagen compuesta o dos capturas mostrando:
    1. El formulario de "Editar Producto" con los datos de un producto existente y un campo modificado (ej: el precio).
    2. La tabla de administración con el **producto actualizado** y la **notificación de éxito** visible.

    ---

    #### Captura 6: Flujo de eliminación (FASE 9)

    * Una imagen compuesta o dos capturas mostrando:
    1. El cuadro de diálogo de confirmación `confirm('¿Estás seguro...?')` al hacer clic en "Eliminar".
    2. La tabla de administración sin el producto eliminado y con la **notificación de éxito** visible.

    ---

    #### Captura 7: Carrito de compras con sesiones (Fase 10)

    * Captura de pantalla de la página del carrito (/cart) funcionando con la lógica de sesiones.
    1. Debe mostrar al menos dos productos diferentes.
    2. Deben ser visibles las imágenes, cantidades, precios, subtotales y el total final calculado.

    ---

    #### Captura 8: Lista de deseos (Fase 11)

    * Captura de la página `/admin/wishlist` con al menos 2 productos guardados
    * Debe mostrar productos con información completa (imagen, nombre, precio, oferta si aplica)
    * Botones "Añadir al Carrito" y botón "❌" para eliminar visibles
    * Usuario autenticado (navegación superior debe mostrar el nombre del usuario)
    * URL `/admin/wishlist` visible en el navegador

    ---

    #### Captura 9: Middleware de registro de actividad (FASE 12)

    * Terminal ejecutando `tail -f storage/logs/laravel.log`.
    * El log debe mostrar al menos una entrada de "Actividad de usuario" después de haber navegado a una página de administración como usuario autenticado.

    ---

    ### 📤 Instrucciones de entrega

    1. **Formato**: Entregar un único archivo PDF con todas las capturas
    2. **Organización**: Incluir un título para cada captura explicando qué muestra
    3. **Calidad**: Las capturas deben ser claras y legibles
    4. **Numeración**: Las capturas deben estar numeradas del 1 al 9 según el orden especificado
    5. **Funcionalidad**: Todas las rutas deben funcionar correctamente
    6. **Terminal**: Las capturas que requieran terminal deben mostrar el prompt `usuario@equipo:~/ruta/proyecto$` visible
    7. **Autenticación**: Las capturas de áreas protegidas deben mostrar el nombre del usuario autenticado en la navegación
    8. **Datos reales**: Utilizar datos reales de tu base de datos, no capturas de ejemplo

