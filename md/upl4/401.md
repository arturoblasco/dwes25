# 4.1. Formularios Seguros

En la **sesi√≥n 2** se aprendi√≥ a crear vistas din√°micas con Blade y a manejar datos desde los controladores. En la **sesi√≥n 3** se domin√≥ Eloquent para persistir datos en la base de datos. Ahora es momento de conectar estas piezas: los **formularios** son el puente que permite a los usuarios enviar informaci√≥n que tu aplicaci√≥n procesar√° y almacenar√° de forma segura.

Los formularios web son la puerta de entrada de datos en las aplicaciones, pero tambi√©n representan un **vector de ataque cr√≠tico**. Laravel proporciona herramientas robustas para crear formularios seguros que protegen contra vulnerabilidades comunes como CSRF, inyecci√≥n de c√≥digo y manipulaci√≥n de datos.

## 1. Fundamentos de los Formularios Web

### 1.1. ¬øQu√© es un Formulario Web?

Un formulario web es un elemento HTML que permite a los usuarios enviar datos al servidor de manera estructurada. Los formularios son esenciales para la interacci√≥n usuario-aplicaci√≥n, pero requieren implementaci√≥n cuidadosa para mantener la seguridad.

???examplelaravel "Analog√≠a: El Formulario como Sistema de Compra de Entradas del Festival"

    **¬°Imagina que un formulario web es como el sistema completo de compra de entradas para un festival de m√∫sica!**

    * üé´ **Formulario de compra**: El sitio web donde rellenas tus datos

    + Nombre, DNI, email, m√©todo de pago
    + Todo debe ser verificado antes de procesar
    * üîê **Token CSRF (c√≥digo de seguridad √∫nico)**: Como el c√≥digo de confirmaci√≥n de Ticketmaster

    + Cada sesi√≥n de compra tiene un c√≥digo √∫nico
    + Previene que alguien compre entradas en tu nombre sin tu conocimiento
    + "Esta compra fue iniciada por TI desde TU navegador"
    * ‚úÖ **Validaci√≥n (sistema de pagos)**: El banco verifica todo

    + ¬øLa tarjeta es v√°lida?
    + ¬øTienes fondos suficientes?
    + ¬øLos datos coinciden?
    * üéüÔ∏è **Ticket con QR (ruta protegida)**: Tu entrada final con c√≥digo QR √∫nico

    + Solo t√∫ puedes usar esta entrada
    + El QR se escanea en la entrada del festival
    + No se puede duplicar ni falsificar

    **¬°Sin este sistema de seguridad, cualquiera podr√≠a comprar entradas en tu nombre o falsificar tickets!**

### 1.2. Componentes de un Formulario Seguro

Un formulario seguro en Laravel est√° compuesto por varios elementos que trabajan en conjunto para garantizar la integridad y seguridad de los datos:

| Componente | Descripci√≥n | Prop√≥sito de Seguridad |
| --- | --- | --- |
| **M√©todo HTTP** | GET, POST, PUT, DELETE | Especificar el tipo de operaci√≥n |
| **Acci√≥n (Action)** | URL de destino | Definir d√≥nde se env√≠an los datos |
| **Campos de entrada** | Input, textarea, select | Capturar datos del usuario |
| **Protecci√≥n CSRF** | Token √∫nico | Prevenir ataques Cross-Site Request Forgery |
| **Validaci√≥n** | Reglas de datos | Asegurar integridad y formato correcto |
| **Sanitizaci√≥n** | Limpieza de datos | Prevenir inyecci√≥n de c√≥digo |

## 2. Protecci√≥n CSRF en Laravel

La protecci√≥n CSRF es la primera l√≠nea de defensa contra ataques de falsificaci√≥n de peticiones. Laravel incluye esta protecci√≥n de forma autom√°tica y solo requiere una directiva simple en tus formularios.

### 2.1. ¬øQu√© es CSRF?

**Cross-Site Request Forgery (CSRF)** es un ataque que explota la confianza de un sitio web en un usuario autenticado. Un atacante puede hacer que el navegador del usuario env√≠e peticiones no deseadas a un sitio web en el que el usuario est√° autenticado, sin que el usuario lo sepa.

???examplelaravel "Analog√≠a: CSRF como Falsificaci√≥n de Entradas del Festival"

    **¬°Imagina que CSRF es como un falsificador de entradas en el festival!**

    üé≠ **El Ataque:**

    1. **Compras tu entrada leg√≠tima** para el festival y la guardas en tu m√≥vil (sesi√≥n autenticada)
    2. **Visitas un sitio web sospechoso** que parece vender merchandising oficial del festival
    3. **Sin que lo sepas, ese sitio web malicioso** hace clic en un bot√≥n invisible que dice: 

    ```html
    <form action="https://festivaltickets.com/comprar-vip-upgrade" method="POST">
        <input type="hidden" name="cantidad" value="10">
        <input type="hidden" name="tarjeta_guardada" value="true">
    </form>
    <script>document.forms[0].submit();</script>
    ```
    4. **Tu navegador env√≠a la petici√≥n autom√°ticamente** al sitio leg√≠timo
    5. **El servidor del festival ve tu sesi√≥n activa** (tienes la entrada v√°lida en el m√≥vil)
    6. **El servidor conf√≠a en la petici√≥n** porque vienes de una sesi√≥n autenticada
    7. **üí∏ ¬°Te han comprado 10 upgrades VIP sin tu consentimiento!**

    üõ°Ô∏è **La Protecci√≥n (Token CSRF):**

    Es como a√±adir un **holograma de seguridad √∫nico** a cada transacci√≥n:

    * Cuando abres el formulario de compra, recibes un c√≥digo hologr√°fico √∫nico de un solo uso
    * Ese c√≥digo solo lo conocen tu navegador y el servidor del festival
    * Cuando env√≠as el formulario, debe incluir ese holograma exacto
    * El sitio web malicioso **no puede conocer** tu holograma secreto
    * **Sin el holograma ‚Üí transacci√≥n rechazada**

    **¬°El token CSRF es tu holograma de seguridad que impide las falsificaciones!**

### 2.2. C√≥mo Funciona la Protecci√≥n CSRF

Laravel genera autom√°ticamente un token CSRF √∫nico para cada sesi√≥n de usuario:

```php
<?php
// Laravel genera autom√°ticamente el token CSRF
@csrf

// Esto equivale a:
<input type="hidden" name="_token" value="{{ csrf_token() }}">
```

**Flujo de Protecci√≥n CSRF:**

```mermaid
sequenceDiagram
    participant U as üë§ Usuario
    participant B as üåê Navegador
    participant L as ‚ö° Laravel
    participant D as üóÑÔ∏è Base de Datos

    U->>B: Visita formulario de compra
    B->>L: GET /products/create
    L->>L: Genera token CSRF √∫nico
    Note over L: Token: abc123xyz789
    L->>B: Renderiza formulario con token
    Note over B: <input name="_token" value="abc123xyz789">
    
    U->>B: Rellena y env√≠a formulario
    B->>L: POST /products (con token)
    Note over B,L: _token: abc123xyz789
    
    L->>L: Verifica token CSRF
    alt Token v√°lido ‚úÖ
        L->>D: Guarda producto
        D->>L: Producto guardado
        L->>B: Redirige a producto creado
        B->>U: Muestra confirmaci√≥n
    else Token inv√°lido ‚ùå
        L->>B: Error 419 (CSRF Token Mismatch)
        B->>U: Muestra error de seguridad
    end
```

Token CSRF Obligatorio

**Todos los formularios que usan POST, PUT, PATCH o DELETE deben incluir el token CSRF.**

Sin `@csrf`, Laravel rechazar√° la petici√≥n con error **419 (Page Expired)**.

```html
<!-- ‚ùå Sin protecci√≥n - Error 419 -->
<form method="POST" action="/products">
    <button>Enviar</button>
</form>

<!-- ‚úÖ Con protecci√≥n - Funciona -->
<form method="POST" action="/products">
    @csrf
    <button>Enviar</button>
</form>
```

### 2.3. Implementaci√≥n de Protecci√≥n CSRF

Implementar la protecci√≥n CSRF en Laravel es muy sencillo. A continuaci√≥n ver√°s c√≥mo aplicarla tanto en formularios tradicionales de Blade como en peticiones AJAX.

#### En Formularios Blade

La forma m√°s simple y com√∫n de proteger un formulario es a√±adiendo la directiva `@csrf` dentro del elemento `<form>`. Laravel generar√° autom√°ticamente un campo hidden con el token.

```html
<form action="{{ route('products.store') }}" method="POST">
    @csrf
    <!-- Campos del formulario -->
    <input type="text" name="name" required>
    <button type="submit">Enviar</button>
</form>
```

#### En Formularios AJAX

Para peticiones AJAX (usando fetch, axios, o jQuery), necesitas incluir el token CSRF en los headers de la petici√≥n. El token se obtiene de una meta tag que Laravel incluye autom√°ticamente en el layout.

```javascript
// Obtener el token CSRF
const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Incluir en peticiones AJAX
fetch('/products', {
    method: 'POST',
    headers: {
        'X-CSRF-TOKEN': token,
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
});
```

## 3. Mejores Pr√°cticas de Seguridad

La protecci√≥n CSRF es solo el primer paso. Para crear formularios verdaderamente seguros, debes implementar m√∫ltiples capas de seguridad que trabajen en conjunto.

### 3.1. Validaci√≥n de Datos
La validaci√≥n es el proceso fundamental de verificar que todos los datos enviados por el usuario cumplan con los criterios y reglas que has definido. Antes de guardar cualquier informaci√≥n en la base de datos o procesarla en tu aplicaci√≥n, debes asegurarte de que sea del tipo correcto, tenga el formato esperado y cumpla con las restricciones de negocio.

???examplelaravel "Analog√≠a: Control de Entrada al Festival"

    **¬°Imagina la validaci√≥n como los controles de seguridad en la entrada del festival!**

    üé´ **Control de Tickets:**

    * ¬øTienes un ticket v√°lido? ‚Üí `'ticket' => 'required'`
    * ¬øEs un c√≥digo QR legible? ‚Üí `'qr_code' => 'string|size:32'`
    * ¬øEl ticket es para este festival? ‚Üí `'event_id' => 'exists:events,id'`
    * ¬øNo est√° duplicado? ‚Üí `'ticket' => 'unique:attendees'`

    üÜî **Verificaci√≥n de Identidad:**

    * ¬øEres mayor de 18? ‚Üí `'age' => 'integer|min:18'`
    * ¬øTu DNI es v√°lido? ‚Üí `'dni' => 'regex:/^[0-9]{8}[A-Z]$/'`
    * ¬øTu email funciona? ‚Üí `'email' => 'email|max:255'`

    **Si no pasas los controles ‚Üí no entras al festival (validaci√≥n falla)**

```php
<?php
// Validaci√≥n completa de formulario de producto
$request->validate([
    'name' => 'required|string|max:255',        // Nombre obligatorio, texto, m√°x 255 caracteres
    'email' => 'required|email|unique:users',   // Email obligatorio, formato v√°lido, √∫nico
    'password' => 'required|min:8|confirmed',   // Contrase√±a m√≠nimo 8 caracteres, con confirmaci√≥n
    'price' => 'required|numeric|min:0',        // Precio obligatorio, num√©rico, positivo
    'category_id' => 'required|exists:categories,id', // Categor√≠a debe existir en BD
]);
```

Validaci√≥n en Profundidad

La validaci√≥n se cubrir√° en detalle en el **apartado 2 (Sistema de Validaci√≥n)** de esta sesi√≥n, donde ver√°s todas las reglas disponibles, validaci√≥n personalizada y manejo de errores.

### 3.2. Sanitizaci√≥n de Datos

La sanitizaci√≥n es el proceso de limpiar y normalizar los datos recibidos para eliminar cualquier c√≥digo potencialmente peligroso o caracteres no deseados. Esto previene ataques de inyecci√≥n de c√≥digo (XSS) donde un usuario malicioso intenta insertar JavaScript o HTML que se ejecutar√≠a en el navegador de otros usuarios.

```php
<?php
// ‚úÖ Laravel sanitiza autom√°ticamente los datos de entrada
$name = $request->input('name'); // Autom√°ticamente escapado

// ‚úÖ Remover etiquetas HTML si es necesario
$description = strip_tags($request->input('description'));

// ‚úÖ Limpiar espacios en blanco
$username = trim($request->input('username'));
```

Peligro: XSS (Cross-Site Scripting)

Sin sanitizaci√≥n, un atacante podr√≠a inyectar c√≥digo JavaScript malicioso:

```html
<!-- Usuario malicioso env√≠a en el campo "name": -->
<script>alert('Hackeado!'); document.location='http://sitio-malicioso.com';</script>
```

**Si muestras este dato sin escapar**, el script se ejecutar√° en el navegador de todos los usuarios.

**Protecci√≥n de Laravel:**

```php
<?php
<!-- ‚úÖ Blade escapa autom√°ticamente -->
{{ $product->name }}  
<!-- Muestra: &lt;script&gt;alert('Hackeado!')&lt;/script&gt; -->

<!-- ‚ùå PELIGROSO: No escapar -->
{!! $product->name !!}  
<!-- Ejecuta el script malicioso -->
```

### 3.3. Protecci√≥n de Rutas

No todos los usuarios deben tener acceso a todos los formularios. Usa el middleware `auth` para restringir el acceso a rutas sensibles:

```php
<?php
// Proteger rutas de administraci√≥n
Route::middleware('auth')->group(function () {
    Route::post('/products', [ProductController::class, 'store']);
    Route::put('/products/{product}', [ProductController::class, 'update']);
    Route::delete('/products/{product}', [ProductController::class, 'destroy']);
});

// Rutas p√∫blicas
Route::get('/products', [ProductController::class, 'index']);
```

Autenticaci√≥n y Protecci√≥n de Rutas

El sistema de autenticaci√≥n y protecci√≥n de rutas se cubre en profundidad en el **apartado 4 (Autenticaci√≥n B√°sica)**.

### 3.4. Rate Limiting (Limitaci√≥n de Peticiones)

El rate limiting controla cu√°ntas veces un usuario puede enviar un formulario en un per√≠odo de tiempo determinado, previniendo ataques de fuerza bruta y spam.

```php
<?php
// Limitar formulario de login
Route::post('/login', [AuthController::class, 'login'])
    ->middleware('throttle:5,1'); // 5 intentos por minuto

// Limitar creaci√≥n de productos
Route::post('/products', [ProductController::class, 'store'])
    ->middleware('throttle:10,1'); // 10 productos por minuto
```

Rate Limiting en Profundidad

El rate limiting personalizado con l√≥gica compleja se cubre en detalle en el **apartado 5 (Middleware Personalizado)**, donde aprender√°s a crear rate limiting diferenciado por roles, recursos espec√≠ficos, y m√°s.

## 4. Tipos de Formularios Comunes

Laravel gestiona diferentes tipos de formularios seg√∫n la operaci√≥n CRUD que realizan. Cada tipo tiene caracter√≠sticas espec√≠ficas de seguridad y m√©todos HTTP apropiados.

### 4.1. Formularios de Creaci√≥n

Los formularios de creaci√≥n usan el m√©todo POST para enviar nuevos datos al servidor. Son la base de cualquier aplicaci√≥n que permita a los usuarios a√±adir contenido.

```html
<form action="{{ route('products.store') }}" method="POST">
    @csrf
    <div>
    <label for="name">Nombre del Producto</label>
    <input type="text" id="name" name="name" required>
    </div>
    <div>
    <label for="description">Descripci√≥n</label>
    <textarea id="description" name="description" required></textarea>
    </div>
    <button type="submit">Crear Producto</button>
</form>
```

### 4.2. Formularios de Edici√≥n

Los formularios de edici√≥n actualizan datos existentes usando el m√©todo PUT (spoofed mediante `@method('PUT')`). Deben pre-cargar los valores actuales para que el usuario vea qu√© est√° modificando.

```html
<form action="{{ route('products.update', $product->id) }}" method="POST">
    @csrf
    @method('PUT')
    <div>
        <label for="name">Nombre del Producto</label>
    <input type="text" id="name" name="name" value="{{ $product->name }}" required>
    </div>
    <button type="submit">Actualizar Producto</button>
</form>
```

### 4.3. Formularios de Eliminaci√≥n

Los formularios de eliminaci√≥n usan el m√©todo DELETE para borrar recursos. Por seguridad, siempre deben requerir confirmaci√≥n del usuario antes de ejecutarse.

```html
<form action="{{ route('products.destroy', $product->id) }}" method="POST">
    @csrf
    @method('DELETE')
    <button type="submit" onclick="return confirm('¬øEst√°s seguro?')">
        Eliminar Producto
    </button>
</form>
```

## 5. Formularios Avanzados

Los formularios no solo env√≠an texto simple. A menudo necesitan manejar archivos, m√∫ltiples opciones (checkboxes), o selecciones de listas. Cada caso requiere configuraci√≥n espec√≠fica.

### 5.1. Formularios con Archivos

Para subir archivos, el formulario requiere el atributo `enctype="multipart/form-data"`:

```html
<form action="{{ route('products.store') }}" method="POST" enctype="multipart/form-data">
    @csrf
    <input type="file" name="image" accept="image/*">
</form>
```

Gesti√≥n Completa de Archivos

El flujo completo de subida de archivos (validaci√≥n, almacenamiento, actualizaci√≥n, eliminaci√≥n y mejores pr√°cticas) se cubre en el **apartado 7 (Sistema de Almacenamiento de Archivos)**.

### 5.2. Formularios con Checkboxes
Los checkboxes permiten seleccionar m√∫ltiples opciones. Laravel recibe estos valores como un array si usas la notaci√≥n `name="campo[]"`.

```html
<div>
<label>Etiquetas</label>
    @foreach($tags as $tag)
    <label>
        <input type="checkbox" name="tags[]" value="{{ $tag->id }}">
        {{ $tag->name }}
        </label>
    @endforeach
</div>
```

### 5.3. Formularios con Selects

Los elementos `<select>` permiten elegir una opci√≥n de una lista desplegable. Son ideales para campos con opciones limitadas y predefinidas como categor√≠as, pa√≠ses o roles.

```html
<div>
    <label for="category_id">Categor√≠a</label>
    <select id="category_id" name="category_id" required>
        <option value="">Selecciona una categor√≠a</option>
        @foreach($categories as $category)
            <option value="{{ $category->id }}">{{ $category->name }}</option>
        @endforeach
    </select>
</div>
```
