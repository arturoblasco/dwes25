# 4.2. Sistema de Validaci√≥n

En el **apartado 1** viste c√≥mo proteger formularios con CSRF y buenas pr√°cticas de seguridad. Ahora es momento de profundizar en el **coraz√≥n de la seguridad de formularios**: el sistema de validaci√≥n de Laravel.

La validaci√≥n es el proceso de verificar que los datos ingresados por el usuario cumplan con los criterios especificados antes de ser procesados por la aplicaci√≥n. Laravel proporciona un sistema de validaci√≥n robusto y flexible que permite crear reglas personalizadas, manejar errores elegantemente y proporcionar feedback claro al usuario.

## 1. Fundamentos de la Validaci√≥n

### 1.1. ¬øQu√© es la Validaci√≥n?

La validaci√≥n es el proceso de verificar que los datos cumplan con las reglas definidas antes de ser procesados. Es una capa de seguridad esencial que previene errores, mantiene la integridad de los datos y mejora la experiencia del usuario.

???examplelaravel "Analog√≠a: Control de Acceso Multinivel del Festival"

    **¬°Imagina la validaci√≥n como los m√∫ltiples controles de seguridad para entrar a un festival de m√∫sica!**

    üé´ **Control 1 - Entrada Principal:**

    * ¬øTienes un ticket leg√≠timo con c√≥digo QR? ‚Üí `'ticket' => 'required'`
    * ¬øEl c√≥digo QR es escaneable y tiene el formato correcto? ‚Üí `'qr_code' => 'string|size:32'`
    * ¬øEs para el festival correcto (no es para otro evento)? ‚Üí `'event_id' => 'exists:events,id'`

    üÜî **Control 2 - Verificaci√≥n de Identidad:**

    * ¬øEres mayor de edad (18+)? ‚Üí `'age' => 'integer|min:18'`
    * ¬øTu DNI coincide con los datos del ticket? ‚Üí `'dni' => 'required|regex:/^[0-9]{8}[A-Z]$/'`
    * ¬øTu email es v√°lido por si necesitamos contactarte? ‚Üí `'email' => 'required|email'`

    üö´ **Control 3 - Anti-Duplicados:**

    * ¬øEste ticket ya fue usado en la entrada? ‚Üí `'ticket_id' => 'unique:entries'`
    * ¬øEste DNI ya est√° dentro del recinto? ‚Üí `'dni' => 'unique:attendees,dni'`

    üí≥ **Control 4 - Zona VIP (Validaci√≥n Adicional):**

    * Si accedes a VIP, ¬øtienes la pulsera correcta? ‚Üí `'vip_pass' => 'required_if:zone,vip'`
    * ¬øTu tarjeta VIP est√° activa? ‚Üí `'vip_pass' => 'exists:vip_passes,code'`

    **Si fallas cualquier control ‚Üí No entras al festival (validaci√≥n falla y devuelve error)**

    **¬°El sistema de validaci√≥n de Laravel es como tener guardias de seguridad autom√°ticos que verifican TODO antes de dejar pasar datos!**

### 1.2. Tipos de Validaci√≥n

| Tipo | Descripci√≥n | Ejemplo |
| --- | --- | --- |
| **Frontend** | Validaci√≥n en el navegador | JavaScript, HTML5 |
| **Backend** | Validaci√≥n en el servidor | Laravel Validation |
| **Base de Datos** | Validaci√≥n a nivel de BD | Constraints, Triggers |

???examplelaravel "Analog√≠a: Validaci√≥n en Cascada como Controles del Festival"

    **¬°Imagina que la validaci√≥n en 3 capas es como los controles de seguridad del festival en diferentes momentos!**

    üé´ **Capa 1 - Frontend (Validaci√≥n en el Navegador):**

    * **Momento**: Antes de hacer cola
    * **Verificaci√≥n r√°pida visual**: "¬øTu ticket parece v√°lido a simple vista?"
    * **Objetivo**: Evitar que hagas cola innecesariamente si falta informaci√≥n obvia
    * **Tecnolog√≠a**: HTML5 (`required`, `minlength`), JavaScript
    * **Ejemplo**: El formulario te avisa al instante si olvidaste poner tu email

    ```html
    <input type="email" required>
    <!-- El navegador valida al instante, sin enviar al servidor -->
    ```

    ‚ö° **Capa 2 - Backend (Validaci√≥n en Laravel - LA M√ÅS IMPORTANTE):**

    * **Momento**: En la puerta de entrada del festival
    * **Escaneo completo del c√≥digo QR**: Verificaci√≥n exhaustiva del sistema
    * **Objetivo**: Seguridad real - NUNCA confiar solo en el frontend
    * **Tecnolog√≠a**: Laravel Validation (este apartado completo)
    * **Por qu√© es crucial**: Un atacante puede desactivar JavaScript y saltarse el frontend

    ```php
    $request->validate([
        'email' => 'required|email|unique:users',
        'age' => 'required|integer|min:18',
    ]);
    // Laravel verifica TODO de nuevo en el servidor
    ```

    üóÑÔ∏è **Capa 3 - Base de Datos (√öltima L√≠nea de Defensa):**

    * **Momento**: Al intentar guardar en la base de datos
    * **Verificaci√≥n final**: ¬øEste ticket ya fue usado? (constraint UNIQUE en BD)
    * **Objetivo**: Garantizar integridad de datos incluso si Laravel falla
    * **Tecnolog√≠a**: Constraints SQL (UNIQUE, FOREIGN KEY, CHECK)


    ```sql
    CREATE TABLE users (
        email VARCHAR(255) UNIQUE,  -- La BD rechaza duplicados
        age INT CHECK (age >= 18)   -- La BD rechaza menores de 18
    );
    ```

**¬øPor qu√© 3 capas?**

* **Frontend**: Mejora experiencia del usuario (feedback inmediato).
* **Backend**: Seguridad real (nunca confiar en el cliente).
* **Base de datos**: √öltima defensa (por si algo falla en Backend).

---

> **La Validaci√≥n Backend es Obligatoria**
> 
> **NUNCA te f√≠es solo de la validaci√≥n Frontend**. Un atacante puede:
> 
> * Desactivar JavaScript en su navegador
> * Modificar el HTML con las herramientas del navegador
> * Enviar peticiones HTTP directamente sin usar tu formulario
> 
> **La validaci√≥n de Laravel (backend) es tu verdadera seguridad.**

## 2. Sistema de Validaci√≥n de Laravel

Laravel proporciona un sistema de validaci√≥n potente y expresivo que permite definir reglas de manera clara y concisa. Veamos desde la validaci√≥n m√°s b√°sica hasta casos avanzados.

### 2.1. Validaci√≥n B√°sica

La forma m√°s simple de validar datos en Laravel es usando el m√©todo **`validate()`** directamente en el request dentro del controlador.


```php
<?php
// Validaci√≥n b√°sica en el controlador
public function store(Request $request)
{
    $validated = $request->validate([
        'name' => 'required|string|max:255',
        'email' => 'required|email|unique:users',
        'password' => 'required|min:8|confirmed',
    ]);

    // Los datos validados est√°n disponibles en $validated
    User::create($validated);
}
```

### 2.2. Reglas de Validaci√≥n Comunes

Laravel incluye docenas de reglas de validaci√≥n predefinidas para los casos m√°s comunes. Aqu√≠ est√°n las m√°s utilizadas:

| Regla | Descripci√≥n | Ejemplo |
| --- | --- | --- |
| `required` | Campo obligatorio | `'name' => 'required'` |
| `string` | Debe ser texto | `'name' => 'string'` |
| `email` | Formato de email v√°lido | `'email' => 'email'` |
| `numeric` | Debe ser num√©rico | `'price' => 'numeric'` |
| `min:valor` | Valor m√≠nimo | `'age' => 'min:18'` |
| `max:valor` | Valor m√°ximo | `'name' => 'max:255'` |
| `unique:tabla` | √önico en la tabla | `'email' => 'unique:users'` |
| `confirmed` | Debe tener confirmaci√≥n | `'password' => 'confirmed'` |
| `exists:tabla` | Debe existir en la tabla | `'category_id' => 'exists:categories,id'` |

### 2.3. Validaci√≥n con M√∫ltiples Reglas

Puedes combinar m√∫ltiples reglas de validaci√≥n en un solo campo usando el separador **`|`** (pipe) o mediante un array.

```php
<?php
$request->validate([
    'name' => 'required|string|max:255|min:3',
    'email' => 'required|email|unique:users,email',
    'password' => 'required|string|min:8|confirmed',
    'age' => 'required|integer|min:18|max:120',
    'website' => 'nullable|url',
    'phone' => 'nullable|regex:/^[0-9]{9}$/',
]);
```

## 3. Validaci√≥n Avanzada

Las aplicaciones reales a menudo requieren validaci√≥n de estructuras complejas: arrays de datos, campos condicionales y archivos con requisitos espec√≠ficos.

### 3.1. Validaci√≥n de Arrays

Cuando tu formulario env√≠a m√∫ltiples elementos (como una lista de productos o etiquetas), Laravel puede validar cada elemento del array individualmente usando la notaci√≥n con asterisco **`*`**.

```php
<?php
// Validaci√≥n de arrays
$request->validate([
    'tags' => 'array',
    'tags.*' => 'exists:tags,id',
    'products' => 'array|min:1',
    'products.*.name' => 'required|string',
    'products.*.price' => 'required|numeric|min:0',
]);
```

### 3.2. Validaci√≥n Condicional

A veces necesitas validar un campo solo si se cumple cierta condici√≥n. Por ejemplo, solicitar el nombre de empresa solo si el tipo de usuario es "empresa".

```php
<?php
// Validaci√≥n condicional
$request->validate([
    'type' => 'required|in:individual,company',
    'company_name' => 'required_if:type,company|string|max:255',
    'tax_id' => 'required_if:type,company|string|max:20',
]);
```

### 3.3. Validaci√≥n de Archivos

La validaci√≥n de archivos es cr√≠tica para la seguridad. Laravel proporciona reglas espec√≠ficas para verificar el tipo, tama√±o y dimensiones de archivos subidos.

```php
<?php
// Validaci√≥n de archivos
$request->validate([
    'image' => 'required|image|mimes:jpeg,png,jpg|max:2048',
    'document' => 'nullable|file|mimes:pdf,doc,docx|max:10240',
    'avatar' => 'nullable|image|dimensions:min_width=100,min_height=100',
]);
```

## 4. Reglas Personalizadas

Laravel proporciona decenas de reglas de validaci√≥n predefinidas, pero a veces necesitas crear reglas espec√≠ficas para tu aplicaci√≥n.

### 4.1. Crear Reglas Personalizadas

Cuando las reglas predefinidas de Laravel no cubren tus necesidades espec√≠ficas, puedes crear tus propias reglas de validaci√≥n personalizadas. Esto es √∫til para validaciones complejas de negocio que requieren l√≥gica espec√≠fica de tu aplicaci√≥n.

???examplelaravel "Analog√≠a: Control VIP Personalizado del Festival"

    **¬°Imagina que necesitas un control de seguridad especial para la zona VIP del festival!**

    üéüÔ∏è **Reglas est√°ndar de Laravel**: Como los controles normales del festival

    * Mayor de 18 ‚Üí `'age' => 'min:18'`
    * Email v√°lido ‚Üí `'email' => 'email'`
    * Ticket √∫nico ‚Üí `'ticket' => 'unique:tickets'`

    üíé **Reglas personalizadas**: Controles especiales para zonas exclusivas

    * ¬øLa contrase√±a tiene letra may√∫scula, min√∫scula, n√∫mero Y s√≠mbolo? ‚Üí `StrongPassword`
    * ¬øEl c√≥digo de invitaci√≥n VIP es de un artista autorizado? ‚Üí `ValidArtistCode`
    * ¬øEl nombre de usuario no contiene palabras prohibidas? ‚Üí `NotBlacklisted`

    **Cuando las reglas est√°ndar no cubren tu necesidad espec√≠fica ‚Üí creas tu propia regla personalizada**

```php
<?php
// Crear regla personalizada
php artisan make:rule StrongPassword
```

```php
<?php

namespace App\Rules;

use Illuminate\Contracts\Validation\Rule;

class StrongPassword implements Rule
{
    public function passes($attribute, $value)
    {
        return preg_match('/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/', $value);
    }

    public function message()
    {
        return 'La contrase√±a debe contener al menos 8 caracteres, una may√∫scula, una min√∫scula, un n√∫mero y un car√°cter especial.';
    }
}
```

### 4.2. Usar Reglas Personalizadas

Una vez creada la regla personalizada, puedes usarla como cualquier otra regla de validaci√≥n de Laravel.

```php
<?php
use App\Rules\StrongPassword;

$request->validate([
    'password' => ['required', new StrongPassword],
]);
```

### 4.3. Reglas con Par√°metros

Las reglas personalizadas pueden aceptar par√°metros en su constructor, permitiendo crear validaciones m√°s flexibles y reutilizables.

```php
<?php

namespace App\Rules;

use Illuminate\Contracts\Validation\Rule;

class NotBlacklisted implements Rule
{
    protected $blacklist;

    public function __construct($blacklist = [])
    {
        $this->blacklist = $blacklist;
    }

    public function passes($attribute, $value)
    {
        return !in_array(strtolower($value), $this->blacklist);
    }

    public function message()
    {
        return 'El valor no est√° permitido.';
    }
}
```

## 5. Manejo de Errores

Cuando la validaci√≥n falla, Laravel redirige autom√°ticamente al usuario de vuelta al formulario con los errores. Es crucial mostrar estos errores de forma clara para que el usuario sepa qu√© corregir.

### 5.1. Mostrar Errores en Blade

```html
<!-- Mostrar errores espec√≠ficos -->
<div>
    <label for="name">Nombre</label>
    <input type="text" id="name" name="name" 
           class="@error('name') border-red-500 @enderror"
           value="{{ old('name') }}">
    @error('name')
        <p class="text-red-600 text-sm mt-1">{{ $message }}</p>
    @enderror
</div>

<!-- Mostrar todos los errores -->
@if($errors->any())
    <div class="alert alert-danger">
        <ul>
            @foreach($errors->all() as $error)
                <li>{{ $error }}</li>
            @endforeach
        </ul>
    </div>
@endif
```

### 5.2. Mensajes Personalizados

Los mensajes de error predeterminados de Laravel est√°n en ingl√©s. Puedes personalizarlos para que sean m√°s espec√≠ficos y acordes a tu aplicaci√≥n.

```php
<?php
// Mensajes personalizados
$request->validate([
    'email' => 'required|email',
    'password' => 'required|min:8',
], [
    'email.required' => 'El campo email es obligatorio.',
    'email.email' => 'El email debe tener un formato v√°lido.',
    'password.required' => 'La contrase√±a es obligatoria.',
    'password.min' => 'La contrase√±a debe tener al menos 8 caracteres.',
]);
```

### 5.3. Atributos Personalizados

En lugar de personalizar cada mensaje, puedes cambiar c√≥mo Laravel nombra los campos en los mensajes de error.

```php
<?php
// Atributos personalizados
$request->validate([
    'first_name' => 'required|string',
    'last_name' => 'required|string',
], [], [
    'first_name' => 'nombre',
    'last_name' => 'apellido',
]);
```

## 6. Validaci√≥n en Formularios

La validaci√≥n se puede aplicar tanto en el frontend (navegador) como en el backend (Laravel). Ambas son complementarias y necesarias.

### 6.1. Validaci√≥n Frontend con HTML5

HTML5 proporciona validaci√≥n b√°sica en el navegador antes de enviar el formulario, mejorando la experiencia del usuario con feedback inmediato.

```html
<!-- Validaci√≥n HTML5 -->
<form>
    <input type="text" name="name" required minlength="3" maxlength="255">
    <input type="email" name="email" required>
    <input type="password" name="password" required minlength="8">
    <input type="number" name="age" min="18" max="120">
    <input type="url" name="website">
    <input type="tel" name="phone" pattern="[0-9]{9}">
</form>
```

### 6.2. Validaci√≥n con JavaScript

Para validaciones m√°s complejas o personalizadas en el frontend, puedes usar JavaScript puro. Esto te permite crear reglas espec√≠ficas y proporcionar feedback inmediato mientras el usuario rellena el formulario.

```javascript
// Validaci√≥n con JavaScript
function validateForm() {
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if (name.length < 3) {
        showError('name', 'El nombre debe tener al menos 3 caracteres');
        return false;
    }

    if (!isValidEmail(email)) {
        showError('email', 'El email no es v√°lido');
        return false;
    }

    if (password.length < 8) {
        showError('password', 'La contrase√±a debe tener al menos 8 caracteres');
        return false;
    }

    return true;
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}
```

### 6.3. Validaci√≥n en Tiempo Real

La validaci√≥n en tiempo real proporciona feedback instant√°neo mientras el usuario interact√∫a con el formulario. Se activa al salir de un campo (evento `blur`) o mientras escribe (evento `input`), mejorando significativamente la experiencia del usuario.

```javascript
// Validaci√≥n en tiempo real
document.getElementById('email').addEventListener('blur', function() {
    const email = this.value;
    if (email && !isValidEmail(email)) {
        showError('email', 'El email no es v√°lido');
    } else {
        clearError('email');
    }
});
```

## 7. Validaci√≥n de Relaciones

Cuando trabajas con bases de datos relacionales, es crucial validar que las referencias entre tablas sean v√°lidas antes de crear o actualizar registros.

### 7.1. Validaci√≥n de Claves For√°neas

La regla `exists` verifica que un valor exista en una tabla espec√≠fica antes de permitir su uso como clave for√°nea. Esto previene errores de integridad referencial.

```php
<?php
// Validar que la categor√≠a existe
$request->validate([
    'category_id' => 'required|exists:categories,id',
    'tags' => 'array',
    'tags.*' => 'exists:tags,id',
]);
```

### 7.2. Validaci√≥n de Relaciones Muchos a Muchos

En relaciones muchos a muchos (como productos y etiquetas), necesitas validar arrays de IDs para asegurar que todos los elementos relacionados existan en sus respectivas tablas.

```php
<?php
// Validar etiquetas de producto
$request->validate([
    'product_id' => 'required|exists:products,id',
    'tags' => 'array|min:1',
    'tags.*' => 'exists:tags,id',
]);
```

### 7.3. Validaci√≥n de Unicidad con Condiciones

Al editar registros, necesitas validar unicidad pero excluyendo el registro actual. Laravel permite a√±adir excepciones y condiciones adicionales a la regla `unique`.

```php
<?php
// Validar unicidad con condiciones
$request->validate([
    'email' => 'required|email|unique:users,email,' . $user->id,
    'slug' => 'required|unique:products,slug,' . $product->id . ',id,category_id,' . $request->category_id,
]);
```

## 8. Validaci√≥n de Formularios Complejos

Los formularios del mundo real a menudo combinan m√∫ltiples tipos de datos: informaci√≥n b√°sica, relaciones, archivos e inventario. Aqu√≠ ver√°s ejemplos completos de validaci√≥n para estos casos.

### 8.1. Formulario de Producto con Inventario

Un formulario completo de producto incluye datos b√°sicos, relaciones con categor√≠as y etiquetas, control de inventario y archivos. Todas estas validaciones deben trabajar en conjunto.

```php
<?php
// Validaci√≥n completa de producto
$request->validate([
    // Datos del producto
    'name' => 'required|string|max:255',
    'description' => 'required|string|max:1000',
    'price' => 'required|numeric|min:0|max:999999.99',
    'category_id' => 'required|exists:categories,id',
    
    // Etiquetas
    'tags' => 'array',
    'tags.*' => 'exists:tags,id',
    
    // Inventario
    'quantity' => 'required|integer|min:0',
    'location' => 'required|string|max:255',
    'reorder_level' => 'required|integer|min:0',
    
    // Archivo
    'image' => 'nullable|image|mimes:jpeg,png,jpg|max:2048',
]);
```

### 8.2. Validaci√≥n de Formularios Anidados

Los formularios pueden enviar datos en estructuras anidadas (arrays dentro de arrays). Laravel permite validar cada nivel de anidaci√≥n usando la notaci√≥n de punto.

```php
<?php
// Validaci√≥n de formularios anidados
$request->validate([
    'user' => 'required|array',
    'user.name' => 'required|string|max:255',
    'user.email' => 'required|email|unique:users,email',
    'user.profile' => 'required|array',
    'user.profile.bio' => 'nullable|string|max:500',
    'user.profile.avatar' => 'nullable|image|max:1024',
]);
```

## 9. Mejores Pr√°cticas

Para mantener tu c√≥digo limpio, mantenible y escalable, es importante seguir las mejores pr√°cticas de validaci√≥n que Laravel propone.

### 9.1. Validaci√≥n en el Controlador

La forma m√°s directa de validar es hacerlo en el m√©todo del controlador. Es apropiada para validaciones simples que no se reutilizan en m√∫ltiples lugares.

```php
<?php
// Validaci√≥n en el controlador
public function store(Request $request)
{
    $validated = $request->validate([
        'name' => 'required|string|max:255',
        'email' => 'required|email|unique:users',
    ]);

    // Usar solo datos validados
    $user = User::create($validated);
    
    return redirect()->route('users.show', $user)
        ->with('success', 'Usuario creado exitosamente');
}
```

### 9.2. Validaci√≥n en Form Requests

Form Requests: Organizando la Validaci√≥n Compleja

Cuando un formulario tiene muchas reglas de validaci√≥n, es mejor pr√°ctica crear una clase **Form Request** dedicada en lugar de tener todo en el controlador.

**Ventajas:**

* ‚úÖ **C√≥digo limpio**: El controlador se mantiene simple
* ‚úÖ **Reutilizable**: Puedes usar la misma validaci√≥n en m√∫ltiples m√©todos
* ‚úÖ **Autorizaci√≥n integrada**: Puedes verificar permisos en el mismo lugar
* ‚úÖ **Mensajes centralizados**: Todos los mensajes de error en un solo archivo
* ‚úÖ **Testing m√°s f√°cil**: Puedes testear la validaci√≥n de forma aislada

```bash
// Crear Form Request
php artisan make:request StoreProductRequest
```

```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreProductRequest extends FormRequest
{
    public function authorize()
    {
        return true;
    }

    public function rules()
    {
        return [
            'name' => 'required|string|max:255',
            'description' => 'required|string|max:1000',
            'price' => 'required|numeric|min:0',
            'category_id' => 'required|exists:categories,id',
        ];
    }

    public function messages()
    {
        return [
            'name.required' => 'El nombre del producto es obligatorio.',
            'price.min' => 'El precio debe ser mayor a 0.',
        ];
    }
}
```

### 9.3. Usar Form Requests en Controladores


```php
<?php
// Usar Form Request en el controlador
public function store(StoreProductRequest $request)
{
    $validated = $request->validated();
    $product = Product::create($validated);
    
    return redirect()->route('products.show', $product);
}
```
