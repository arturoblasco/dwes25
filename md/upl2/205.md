# 2.5. Del controlador a la vista

Para crear aplicaciones web dinámicas, es fundamental integrar datos desde el backend (controladores) hacia las vistas.

## 1. El arte de pasar datos: del controlador a la vista

El controlador actúa como preparador de información: busca los datos necesarios, los procesa, los estructura y los empaqueta para que la vista pueda consumirlos de forma sencilla. Laravel proporciona múltiples métodos para realizar esta transferencia de datos, cada uno con sus ventajas según el contexto.

### 1.1. Método `view()` con array asociativo

La forma más común de pasar datos es usando un array asociativo como segundo parámetro del método **`view()`**:

```php
// En app/Http/Controllers/ProductController.php
public function index(): View
{
    $products = $this->getAllProducts();
    $categories = $this->getCategories();
    $featuredProduct = $this->getFeaturedProduct();
    
    return view('products.index', [
        'products' => $products,
        'categories' => $categories,
        'featuredProduct' => $featuredProduct,
        'pageTitle' => 'Nuestros Productos'
    ]);
}
```

### 1.2. Método `with()` para datos adicionales

También se puede usar el método **`with()`** para añadir datos después de crear la vista:

```php
public function show(string $id): View
{
    $product = $this->findProduct($id);
    
    return view('products.show')
        ->with('product', $product)
        ->with('relatedProducts', $this->getRelatedProducts($product))
        ->with('reviews', $this->getReviews($product));
}
```

La diferencia principal entre `with()` y pasar un array es que `with()` es más encadenable y puede ser útil para añadir datos condicionalmente.

Por ejemplo, si solo quieres añadir ciertos datos si se cumplen condiciones específicas:

```php
$view = view('dashboard');
if ($user->isAdmin()) {
    $view->with('adminData', $this->getAdminData());
}
if ($user->hasNotifications()) {
    $view->with('notifications', $this->getNotifications($user));
}
return $view;
```

### 1.3. Método `compact()` para Variables Locales

Cuando las variables locales tienen el mismo nombre que las claves del array, se puede usar **`compact()`**:

```php
public function create(): View
{
    $categories = $this->getCategories();
    $tags = $this->getTags();
    $inventory = $this->getInventory();
    
    return view('products.create', compact('categories', 'tags', 'inventory'));
}
```

Guía de Selección de Métodos

**Usa `view([...])`** cuando:

* Pasas múltiples variables con nombres claros.
* Quieres ver todos los datos en un solo lugar.
* Es la forma más común y legible.

**Usa `with()`** cuando:

* Añades datos condicionalmente.
* Encadenas múltiples llamadas.
* Quieres código más fluido.

**Usa `compact()`** cuando:

* Las variables locales tienen el mismo nombre que las claves.
* Tienes muchas variables con nombres descriptivos.
* Prefieres código más compacto.

## 2. Redirección

A veces, después de procesar una solicitud, es necesario redirigir al usuario a otra ruta o acción. Laravel facilita esto con el método **`redirect()`**.

```php
public function store(Request $request)
{
    // Implementación para guardar un nuevo producto
    // ...
    // Redirigir al usuario a la página del producto recién creado
    return redirect()->route('products.show', ['id' => $product->id]);
}
```

### 2.1. Redirección con datos flash

Laravel permite pasar datos temporales (flash data) durante una redirección, que estarán disponibles en la siguiente solicitud. Esto es útil para mensajes de **éxito** o **error**.

```php
public function store(Request $request)
{
    // Implementación para guardar un nuevo producto
    // ...
    if ($error) {
        return redirect()->back()
                         ->withInput()
                         ->with('error', 'Hubo un problema al crear el producto.');
    }
    // Redirigir al usuario a la página del producto recién creado
    return redirect()->route('products.show', ['id' => $product->id])
                     ->with('success', 'Producto creado exitosamente!');
}
```

**Mostrar mensajes flash en la vista:**

```html
<!-- resources/views/products/show.blade.php -->
@if(session('success'))
    <div class="alert alert-success">
        {{ session('success') }}
    </div>
@endif

@if(session('error'))
    <div class="alert alert-error">
        {{ session('error') }}
    </div>
@endif
```

## 3. Compartir datos globalmente

A veces necesitas que ciertos datos estén disponibles en **todas las vistas** sin pasarlos manualmente en cada controlador.

**Caso de uso:** Nombre de la aplicación, usuario autenticado, configuración global

```php
<?php
// app/Providers/AppServiceProvider.php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\View;

class AppServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        // Compartir datos con TODAS las vistas
        View::share('appName', 'Mi Tienda Online');
        View::share('appVersion', '1.0.0');
        View::share('currentYear', date('Y'));
    }
}
```

**Uso en cualquier vista:**

```html
<!-- Ahora TODAS las vistas tienen acceso a estas variables -->
<footer>
    <p>&copy; {{ $currentYear }} {{ $appName }}</p>
    <small>Versión {{ $appVersion }}</small>
</footer>
```

**Responsabilidades Claras**

**✅ En el controlador (lógica de negocio):**

* Obtener datos de la base de datos
* Filtrar, ordenar, paginar
* Formatear datos complejos
* Preparar estructuras de datos
* Cálculos matemáticos o estadísticos

**✅ En la vista (presentación):**

* Iterar sobre colecciones con `@foreach`
* Mostrar/ocultar con `@if`
* Formatear texto con
* Aplicar estilos CSS condicionales

**❌ Evitar en la vista:**

* Consultas a la base de datos
* Lógica de negocio compleja
* Cálculos pesados
* Modificar datos (solo mostrar)